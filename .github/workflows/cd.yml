name: CD Pipeline

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      manual_version:
        description: 'å¯é¸ï¼šæ‰‹å‹•æŒ‡å®šç‰ˆæœ¬ï¼ˆæ ¼å¼ï¼š<prefix>_vä¸».ä¸­.æ¬¡.æµæ°´_èªªæ˜ï¼‰'
        required: false
        type: string

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  STATE_IMAGE: ${{ github.repository_owner }}/sound-state-management
  ANALYSIS_IMAGE: ${{ github.repository_owner }}/sound-analysis-service

jobs:
  parse_version:
    name: è§£æç‰ˆæœ¬æ¨™ç±¤
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.parse.outputs.tag }}
      env: ${{ steps.parse.outputs.env }}
      version: ${{ steps.parse.outputs.version }}
      desc: ${{ steps.parse.outputs.desc }}
      should_deploy: ${{ steps.parse.outputs.should_deploy }}
    steps:
      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è§£æ commit message æ ¼å¼
        id: parse
        shell: bash
        run: |
          # å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥ï¼Œå¦å‰‡å¾ commit message å–å¾—
          if [ -n "${{ inputs.manual_version }}" ]; then
            VERSION_STRING="${{ inputs.manual_version }}"
          else
            # å–å¾—æœ€æ–° commit message çš„ç¬¬ä¸€è¡Œ
            VERSION_STRING=$(git log -1 --pretty=%s)
          fi

          echo "è§£æç‰ˆæœ¬å­—ä¸²: $VERSION_STRING"

          # æª¢æŸ¥æ˜¯å¦ç¬¦åˆç‰ˆæœ¬æ ¼å¼ï¼š{env}_v{ä¸»}.{ä¸­}.{æ¬¡}.{æµæ°´}_{èªªæ˜}
          if [[ "$VERSION_STRING" =~ ^(dev|staging|server_production|edge_production|edge_productio)_v([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)_(.+)$ ]]; then
            ENV_NAME="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}.${BASH_REMATCH[3]}.${BASH_REMATCH[4]}.${BASH_REMATCH[5]}"
            DESC="${BASH_REMATCH[6]}"
            
            # edge_productio* è¦–ç‚º edge_production
            if [ "$ENV_NAME" = "edge_productio" ]; then ENV_NAME="edge_production"; fi

            SHOULD_DEPLOY="true"
            if [ "$ENV_NAME" = "dev" ]; then SHOULD_DEPLOY="false"; fi

            echo "âœ… ç¬¦åˆç‰ˆæœ¬æ ¼å¼"
            echo "   ç’°å¢ƒ: $ENV_NAME"
            echo "   ç‰ˆæœ¬: $VERSION"
            echo "   èªªæ˜: $DESC"
            echo "   éƒ¨ç½²: $SHOULD_DEPLOY"
          else
            echo "â­ï¸ Commit message ä¸ç¬¦åˆç‰ˆæœ¬æ ¼å¼ï¼Œè·³é CD æµç¨‹"
            echo "   æ ¼å¼æ‡‰ç‚º: {env}_v{ä¸»}.{ä¸­}.{æ¬¡}.{æµæ°´}_{èªªæ˜}"
            echo "   ä¾‹å¦‚: staging_v1.0.0.1_add_feature"
            SHOULD_DEPLOY="false"
            ENV_NAME=""
            VERSION=""
            DESC=""
            VERSION_STRING=""
          fi

          echo "tag=$VERSION_STRING" >> "$GITHUB_OUTPUT"
          echo "env=$ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "desc=$DESC" >> "$GITHUB_OUTPUT"
          echo "should_deploy=$SHOULD_DEPLOY" >> "$GITHUB_OUTPUT"

  build_and_push:
    name: å»ºç½®ä¸¦æ¨é€æ˜ åƒ
    needs: parse_version
    if: needs.parse_version.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.parse_version.outputs.version }}
      ENV_NAME: ${{ needs.parse_version.outputs.env }}
    steps:
      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: è¨­å®šæ˜ åƒåç¨±ï¼ˆè½‰æ›ç‚ºå°å¯«ï¼‰
        id: image_names
        shell: bash
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "state_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-state-management" >> "$GITHUB_OUTPUT"
          echo "analysis_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-analysis-service" >> "$GITHUB_OUTPUT"

      - name: ç™»å…¥ GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å»ºç½® State Management
        uses: docker/build-push-action@v5
        with:
          context: .
          file: core/state_management/Dockerfile
          push: true
          tags: |
            ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }}
            ${{ steps.image_names.outputs.state_image }}:${{ env.ENV_NAME }}-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: å»ºç½® Analysis Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: sub_system/analysis_service/Dockerfile
          push: true
          tags: |
            ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}
            ${{ steps.image_names.outputs.analysis_image }}:${{ env.ENV_NAME }}-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy_staging:
    name: éƒ¨ç½²åˆ° Staging
    needs:
      - parse_version
      - build_and_push
    if: needs.parse_version.outputs.env == 'staging'
    runs-on: [self-hosted, staging]
    env:
      VERSION: ${{ needs.parse_version.outputs.version }}
    steps:
      - name: æ¸…ç†å·¥ä½œç›®éŒ„ï¼ˆè§£æ±º Docker ç”¢ç”Ÿçš„æ¬Šé™å•é¡Œï¼‰
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®éŒ„..."
          WORKSPACE="${{ github.workspace }}"
          
          # ä¿®å¾©æ•´å€‹å·¥ä½œç›®éŒ„çš„æ¬Šé™ï¼ˆåŒ…å«å­ç›®éŒ„ï¼‰
          if [ -d "$WORKSPACE" ]; then
            echo "ä¿®å¾©ç›®éŒ„æ¬Šé™: $WORKSPACE"
            sudo chown -R $(whoami):$(id -gn) "$WORKSPACE" || true
            sudo chmod -R u+rwX "$WORKSPACE" || true
          fi
          
          # ä¹Ÿä¿®å¾©ä¸Šå±¤ç›®éŒ„ï¼ˆactions-runner/_work/repo_name/ï¼‰
          PARENT_DIR=$(dirname "$WORKSPACE")
          if [ -d "$PARENT_DIR" ]; then
            echo "ä¿®å¾©ä¸Šå±¤ç›®éŒ„æ¬Šé™: $PARENT_DIR"
            sudo chown -R $(whoami):$(id -gn) "$PARENT_DIR" || true
            sudo chmod -R u+rwX "$PARENT_DIR" || true
          fi
          
          # å¼·åˆ¶åˆªé™¤ __pycache__ å’Œ .pyc æª”æ¡ˆ
          if [ -d "$WORKSPACE" ]; then
            sudo find "$WORKSPACE" -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
            sudo find "$WORKSPACE" -type f -name '*.pyc' -delete 2>/dev/null || true
          fi
          
          echo "âœ… æ¬Šé™ä¿®å¾©å®Œæˆ"

      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: å»ºç«‹ .env æª”æ¡ˆ
        shell: bash
        run: |
          cat <<EOF > .env
          # Staging ç’°å¢ƒè¨­å®šï¼ˆç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿï¼‰

          # MongoDB è¨­å®š
          MONGODB_HOST=${{ secrets.STAGING_MONGODB_HOST }}
          MONGODB_PORT=${{ secrets.STAGING_MONGODB_PORT }}
          MONGODB_USERNAME=${{ secrets.STAGING_MONGODB_USERNAME }}
          MONGODB_PASSWORD=${{ secrets.STAGING_MONGODB_PASSWORD }}
          MONGODB_DATABASE=${{ secrets.STAGING_MONGODB_DATABASE }}

          # RabbitMQ è¨­å®š
          RABBITMQ_HOST=${{ secrets.STAGING_RABBITMQ_HOST }}
          RABBITMQ_PORT=${{ secrets.STAGING_RABBITMQ_PORT }}
          RABBITMQ_USERNAME=${{ secrets.STAGING_RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD=${{ secrets.STAGING_RABBITMQ_PASSWORD }}

          # State Management è¨­å®š
          STATE_MANAGEMENT_PORT=${{ secrets.STAGING_STATE_MANAGEMENT_PORT }}
          STATE_MANAGEMENT_URL=${{ secrets.STAGING_STATE_MANAGEMENT_URL }}
          EOF

          echo "âœ… .env æª”æ¡ˆå·²å»ºç«‹"
          chmod 600 .env

      - name: è¨­å®šæ˜ åƒåç¨±ï¼ˆè½‰æ›ç‚ºå°å¯«ï¼‰
        id: image_names
        shell: bash
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "state_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-state-management" >> "$GITHUB_OUTPUT"
          echo "analysis_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-analysis-service" >> "$GITHUB_OUTPUT"

      - name: ç™»å…¥ GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ‹‰å–æ˜ åƒ
        shell: bash
        run: |
          docker pull ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }}
          docker pull ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}

      - name: ç”¢å‡ºéƒ¨ç½²è¦†è“‹æª”
        shell: bash
        run: |
          cat <<YAML > core/docker-compose.override.ci.yml
          services:
            state_management:
              image: ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }}
              command: ["python", "state_management_main.py"]
            analysis_service:
              image: ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}
              container_name: analysis_service
              restart: unless-stopped
              env_file:
                - ../.env
              environment:
                MONGODB_HOST: \${MONGODB_HOST}
                MONGODB_PORT: \${MONGODB_PORT}
                MONGODB_USERNAME: \${MONGODB_USERNAME}
                MONGODB_PASSWORD: \${MONGODB_PASSWORD}
                MONGODB_DATABASE: \${MONGODB_DATABASE}
                RABBITMQ_HOST: \${RABBITMQ_HOST}
                RABBITMQ_PORT: \${RABBITMQ_PORT}
                STATE_MANAGEMENT_URL: \${STATE_MANAGEMENT_URL}
              volumes:
                - ../sub_system/analysis_service/logs:/app/logs
              depends_on:
                - mongodb
                - rabbitmq
          YAML

      - name: é‡æ–°éƒ¨ç½²æ ¸å¿ƒèˆ‡åˆ†ææœå‹™
        shell: bash
        run: |
          docker compose -f core/docker-compose.yml -f core/docker-compose.override.ci.yml up -d --remove-orphans mongodb rabbitmq state_management analysis_service

      - name: ç­‰å¾… MongoDB å°±ç·’
        shell: bash
        run: |
          echo "ç­‰å¾… MongoDB å•Ÿå‹•..."
          for i in {1..30}; do
            if docker compose -f core/docker-compose.yml exec -T mongodb mongosh --port ${{ secrets.STAGING_MONGODB_PORT }} --eval "db.adminCommand('ping')" 2>/dev/null; then
              echo "âœ… MongoDB å·²å°±ç·’"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/30)"
            sleep 2
          done

      - name: åˆå§‹åŒ–ç®¡ç†å“¡å¸³è™Ÿ
        shell: bash
        run: |
          echo "åˆå§‹åŒ–ç®¡ç†å“¡å¸³è™Ÿ..."
          docker compose -f core/docker-compose.yml exec -T state_management python init_admin.py \
            --username admin \
            --password "${{ secrets.ADMIN_PASSWORD }}" \
            --email "${{ secrets.ADMIN_EMAIL }}"

      - name: èªæ³• smoke test
        shell: bash
        run: |
          docker run --rm ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }} python -m compileall /app
          docker run --rm ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }} python -m compileall /app

      - name: å¥åº·æª¢æŸ¥
        shell: bash
        run: |
          sleep 10
          curl -f http://localhost:${{ secrets.STAGING_STATE_MANAGEMENT_PORT }}/health

      - name: æ¸…ç† Docker ç”¢ç”Ÿçš„æª”æ¡ˆæ¬Šé™ï¼ˆç¢ºä¿ä¸‹æ¬¡ CI å¯æ­£å¸¸é‹è¡Œï¼‰
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†æª”æ¡ˆæ¬Šé™..."
          sudo chown -R $(whoami):$(id -gn) "${{ github.workspace }}" || true
          sudo chown -R $(whoami):$(id -gn) "$(dirname '${{ github.workspace }}')" || true
          echo "âœ… æ¬Šé™æ¸…ç†å®Œæˆ"

  deploy_server_production:
    name: éƒ¨ç½²åˆ° Server Production
    needs:
      - parse_version
      - build_and_push
    if: needs.parse_version.outputs.env == 'server_production'
    runs-on: [self-hosted, server_production]
    env:
      VERSION: ${{ needs.parse_version.outputs.version }}
    steps:
      - name: æ¸…ç†å·¥ä½œç›®éŒ„ï¼ˆè§£æ±º Docker ç”¢ç”Ÿçš„æ¬Šé™å•é¡Œï¼‰
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®éŒ„..."
          WORKSPACE="${{ github.workspace }}"
          
          # ä¿®å¾©æ•´å€‹å·¥ä½œç›®éŒ„çš„æ¬Šé™ï¼ˆåŒ…å«å­ç›®éŒ„ï¼‰
          if [ -d "$WORKSPACE" ]; then
            echo "ä¿®å¾©ç›®éŒ„æ¬Šé™: $WORKSPACE"
            sudo chown -R $(whoami):$(id -gn) "$WORKSPACE" || true
            sudo chmod -R u+rwX "$WORKSPACE" || true
          fi
          
          # ä¹Ÿä¿®å¾©ä¸Šå±¤ç›®éŒ„ï¼ˆactions-runner/_work/repo_name/ï¼‰
          PARENT_DIR=$(dirname "$WORKSPACE")
          if [ -d "$PARENT_DIR" ]; then
            echo "ä¿®å¾©ä¸Šå±¤ç›®éŒ„æ¬Šé™: $PARENT_DIR"
            sudo chown -R $(whoami):$(id -gn) "$PARENT_DIR" || true
            sudo chmod -R u+rwX "$PARENT_DIR" || true
          fi
          
          # å¼·åˆ¶åˆªé™¤ __pycache__ å’Œ .pyc æª”æ¡ˆ
          if [ -d "$WORKSPACE" ]; then
            sudo find "$WORKSPACE" -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
            sudo find "$WORKSPACE" -type f -name '*.pyc' -delete 2>/dev/null || true
          fi
          
          echo "âœ… æ¬Šé™ä¿®å¾©å®Œæˆ"

      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: å»ºç«‹ .env æª”æ¡ˆ
        shell: bash
        run: |
          cat <<EOF > .env
          # Server Production ç’°å¢ƒè¨­å®šï¼ˆç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿï¼‰

          # MongoDB è¨­å®š
          MONGODB_HOST=${{ secrets.PRODUCTION_MONGODB_HOST }}
          MONGODB_PORT=${{ secrets.PRODUCTION_MONGODB_PORT }}
          MONGODB_USERNAME=${{ secrets.PRODUCTION_MONGODB_USERNAME }}
          MONGODB_PASSWORD=${{ secrets.PRODUCTION_MONGODB_PASSWORD }}
          MONGODB_DATABASE=${{ secrets.PRODUCTION_MONGODB_DATABASE }}

          # RabbitMQ è¨­å®š
          RABBITMQ_HOST=${{ secrets.PRODUCTION_RABBITMQ_HOST }}
          RABBITMQ_PORT=${{ secrets.PRODUCTION_RABBITMQ_PORT }}
          RABBITMQ_USERNAME=${{ secrets.PRODUCTION_RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD=${{ secrets.PRODUCTION_RABBITMQ_PASSWORD }}

          # State Management è¨­å®š
          STATE_MANAGEMENT_PORT=${{ secrets.PRODUCTION_STATE_MANAGEMENT_PORT }}
          STATE_MANAGEMENT_URL=${{ secrets.PRODUCTION_STATE_MANAGEMENT_URL }}
          EOF

          echo "âœ… .env æª”æ¡ˆå·²å»ºç«‹"
          chmod 600 .env

      - name: è¨­å®šæ˜ åƒåç¨±ï¼ˆè½‰æ›ç‚ºå°å¯«ï¼‰
        id: image_names
        shell: bash
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "state_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-state-management" >> "$GITHUB_OUTPUT"
          echo "analysis_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-analysis-service" >> "$GITHUB_OUTPUT"

      - name: ç™»å…¥ GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ‹‰å–æ˜ åƒ
        shell: bash
        run: |
          docker pull ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }}
          docker pull ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}

      - name: ç”¢å‡ºéƒ¨ç½²è¦†è“‹æª”
        shell: bash
        run: |
          cat <<YAML > core/docker-compose.override.ci.yml
          services:
            state_management:
              image: ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }}
              command: ["python", "state_management_main.py"]
            analysis_service:
              image: ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}
              container_name: analysis_service
              restart: unless-stopped
              env_file:
                - ../.env
              environment:
                MONGODB_HOST: \${MONGODB_HOST}
                MONGODB_PORT: \${MONGODB_PORT}
                MONGODB_USERNAME: \${MONGODB_USERNAME}
                MONGODB_PASSWORD: \${MONGODB_PASSWORD}
                MONGODB_DATABASE: \${MONGODB_DATABASE}
                RABBITMQ_HOST: \${RABBITMQ_HOST}
                RABBITMQ_PORT: \${RABBITMQ_PORT}
                STATE_MANAGEMENT_URL: \${STATE_MANAGEMENT_URL}
              volumes:
                - ../sub_system/analysis_service/logs:/app/logs
              depends_on:
                - mongodb
                - rabbitmq
          YAML

      - name: éƒ¨ç½²
        shell: bash
        run: |
          docker compose -f core/docker-compose.yml -f core/docker-compose.override.ci.yml up -d --remove-orphans mongodb rabbitmq state_management analysis_service

      - name: ç­‰å¾… MongoDB å°±ç·’
        shell: bash
        run: |
          echo "ç­‰å¾… MongoDB å•Ÿå‹•..."
          for i in {1..30}; do
            if docker compose -f core/docker-compose.yml exec -T mongodb mongosh --port ${{ secrets.PRODUCTION_MONGODB_PORT }} --eval "db.adminCommand('ping')" 2>/dev/null; then
              echo "âœ… MongoDB å·²å°±ç·’"
              break
            fi
            echo "ç­‰å¾…ä¸­... ($i/30)"
            sleep 2
          done

      - name: åˆå§‹åŒ–ç®¡ç†å“¡å¸³è™Ÿ
        shell: bash
        run: |
          echo "åˆå§‹åŒ–ç®¡ç†å“¡å¸³è™Ÿ..."
          docker compose -f core/docker-compose.yml exec -T state_management python init_admin.py \
            --username admin \
            --password "${{ secrets.ADMIN_PASSWORD }}" \
            --email "${{ secrets.ADMIN_EMAIL }}"

      - name: èªæ³• smoke test
        shell: bash
        run: |
          docker run --rm ${{ steps.image_names.outputs.state_image }}:${{ env.VERSION }} python -m compileall /app
          docker run --rm ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }} python -m compileall /app

      - name: å¥åº·æª¢æŸ¥
        shell: bash
        run: |
          sleep 10
          curl -f http://localhost:${{ secrets.PRODUCTION_STATE_MANAGEMENT_PORT }}/health

      - name: æ¸…ç† Docker ç”¢ç”Ÿçš„æª”æ¡ˆæ¬Šé™ï¼ˆç¢ºä¿ä¸‹æ¬¡ CI å¯æ­£å¸¸é‹è¡Œï¼‰
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†æª”æ¡ˆæ¬Šé™..."
          sudo chown -R $(whoami):$(id -gn) "${{ github.workspace }}" || true
          sudo chown -R $(whoami):$(id -gn) "$(dirname '${{ github.workspace }}')" || true
          echo "âœ… æ¬Šé™æ¸…ç†å®Œæˆ"

  deploy_edge_production:
    name: éƒ¨ç½²åˆ° Edge Production
    needs:
      - parse_version
      - build_and_push
    if: needs.parse_version.outputs.env == 'edge_production'
    runs-on: [self-hosted, edge_production]
    env:
      VERSION: ${{ needs.parse_version.outputs.version }}
    steps:
      - name: æ¸…ç†å·¥ä½œç›®éŒ„ï¼ˆè§£æ±º Docker ç”¢ç”Ÿçš„æ¬Šé™å•é¡Œï¼‰
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®éŒ„..."
          WORKSPACE="${{ github.workspace }}"
          
          # ä¿®å¾©æ•´å€‹å·¥ä½œç›®éŒ„çš„æ¬Šé™ï¼ˆåŒ…å«å­ç›®éŒ„ï¼‰
          if [ -d "$WORKSPACE" ]; then
            echo "ä¿®å¾©ç›®éŒ„æ¬Šé™: $WORKSPACE"
            sudo chown -R $(whoami):$(id -gn) "$WORKSPACE" || true
            sudo chmod -R u+rwX "$WORKSPACE" || true
          fi
          
          # ä¹Ÿä¿®å¾©ä¸Šå±¤ç›®éŒ„ï¼ˆactions-runner/_work/repo_name/ï¼‰
          PARENT_DIR=$(dirname "$WORKSPACE")
          if [ -d "$PARENT_DIR" ]; then
            echo "ä¿®å¾©ä¸Šå±¤ç›®éŒ„æ¬Šé™: $PARENT_DIR"
            sudo chown -R $(whoami):$(id -gn) "$PARENT_DIR" || true
            sudo chmod -R u+rwX "$PARENT_DIR" || true
          fi
          
          # å¼·åˆ¶åˆªé™¤ __pycache__ å’Œ .pyc æª”æ¡ˆ
          if [ -d "$WORKSPACE" ]; then
            sudo find "$WORKSPACE" -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
            sudo find "$WORKSPACE" -type f -name '*.pyc' -delete 2>/dev/null || true
          fi
          
          echo "âœ… æ¬Šé™ä¿®å¾©å®Œæˆ"

      - name: å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: å»ºç«‹ .env æª”æ¡ˆ
        shell: bash
        run: |
          cat <<'EOF' > .env
          # Edge Production ç’°å¢ƒè¨­å®šï¼ˆç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿï¼‰
          
          # MongoDB è¨­å®š
          MONGODB_HOST=${{ secrets.EDGE_MONGODB_HOST }}
          MONGODB_PORT=${{ secrets.EDGE_MONGODB_PORT }}
          MONGODB_USERNAME=${{ secrets.EDGE_MONGODB_USERNAME }}
          MONGODB_PASSWORD=${{ secrets.EDGE_MONGODB_PASSWORD }}
          MONGODB_DATABASE=${{ secrets.EDGE_MONGODB_DATABASE }}
          
          # RabbitMQ è¨­å®š
          RABBITMQ_HOST=${{ secrets.EDGE_RABBITMQ_HOST }}
          RABBITMQ_PORT=${{ secrets.EDGE_RABBITMQ_PORT }}
          RABBITMQ_USERNAME=${{ secrets.EDGE_RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD=${{ secrets.EDGE_RABBITMQ_PASSWORD }}
          
          # State Management è¨­å®š
          STATE_MANAGEMENT_PORT=${{ secrets.EDGE_STATE_MANAGEMENT_PORT }}
          STATE_MANAGEMENT_URL=${{ secrets.EDGE_STATE_MANAGEMENT_URL }}
          EOF
          
          echo "âœ… .env æª”æ¡ˆå·²å»ºç«‹"
          chmod 600 .env

      - name: è¨­å®šæ˜ åƒåç¨±ï¼ˆè½‰æ›ç‚ºå°å¯«ï¼‰
        id: image_names
        shell: bash
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "analysis_image=${{ env.REGISTRY }}/${OWNER_LOWER}/sound-analysis-service" >> "$GITHUB_OUTPUT"

      - name: ç™»å…¥ GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ‹‰å–æ˜ åƒ
        shell: bash
        run: |
          docker pull ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}

      - name: éƒ¨ç½²åˆ†æç¯€é»ï¼ˆåƒ… Analysis Serviceï¼‰
        shell: bash
        run: |
          cat <<'YAML' > core/docker-compose.edge.override.yml
          services:
            analysis_service:
              image: ${{ steps.image_names.outputs.analysis_image }}:${{ env.VERSION }}
              container_name: analysis_service
              restart: unless-stopped
              env_file:
                - ../.env
              environment:
                MONGODB_HOST: ${MONGODB_HOST}
                MONGODB_PORT: ${MONGODB_PORT}
                MONGODB_USERNAME: ${MONGODB_USERNAME}
                MONGODB_PASSWORD: ${MONGODB_PASSWORD}
                MONGODB_DATABASE: ${MONGODB_DATABASE}
                RABBITMQ_HOST: ${RABBITMQ_HOST}
                RABBITMQ_PORT: ${RABBITMQ_PORT}
                STATE_MANAGEMENT_URL: ${STATE_MANAGEMENT_URL}
              volumes:
                - ../sub_system/analysis_service/logs:/app/logs
              command: ["python", "analysis_main.py"]
          YAML
          docker compose -f core/docker-compose.edge.override.yml up -d --remove-orphans analysis_service

      - name: æ¸…ç† Docker ç”¢ç”Ÿçš„æª”æ¡ˆæ¬Šé™ï¼ˆç¢ºä¿ä¸‹æ¬¡ CI å¯æ­£å¸¸é‹è¡Œï¼‰
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ æ¸…ç†æª”æ¡ˆæ¬Šé™..."
          sudo chown -R $(whoami):$(id -gn) "${{ github.workspace }}" || true
          sudo chown -R $(whoami):$(id -gn) "$(dirname '${{ github.workspace }}')" || true
          echo "âœ… æ¬Šé™æ¸…ç†å®Œæˆ"
