{% extends "base.html" %}

{% block title %}{% if mode == 'create' %}建立設定{% else %}編輯設定{% endif %}{% endblock %}
{% block page_title %}{% if mode == 'create' %}建立分析設定{% else %}編輯分析設定{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl space-y-4">
    <div class="rounded-lg border border-indigo-100 bg-indigo-50/80 p-4 text-sm text-indigo-900">
        <p class="font-semibold">填寫建議</p>
        <ul class="mt-2 list-disc space-y-1 pl-5">
            <li><span class="font-semibold">分析方法 ID</span> 為必填且不可重複，應與分析節點的 routing key（如 <code class="bg-white/70 px-1.5 py-0.5 rounded">analysis.fan_autoencoder_v2.*</code>）對應。</li>
            <li><span class="font-semibold">分類方法</span> 決定使用何種模型進行分類，選擇非「隨機分類」的方法時需上傳對應模型檔案。</li>
            <li><span class="font-semibold">參數設定</span> 接受任何 JSON 結構，可放置模型路徑、特徵設定與後處理閾值；儲存前請先驗證格式。</li>
            <li>若此設定受路由規則引用，請確保 <span class="font-semibold">啟用狀態</span> 與規則條件一致，以免調度器略過任務。</li>
        </ul>
        <p class="mt-2 text-xs text-indigo-700">更多範例：<code>docs/設定規則說明.html</code>（分析設定章節）。</p>
    </div>
    <form method="POST" class="space-y-6" id="config-form">
        {{ form.hidden_tag() }}

        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="px-4 py-6 sm:p-8">
                <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <!-- 分析方法 ID -->
                    <div class="sm:col-span-4">
                        <label for="analysis_method_id" class="block text-sm font-medium leading-6 text-gray-900">
                            分析方法 ID <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-2">
                            {{ form.analysis_method_id(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", disabled=(mode == 'edit'), readonly=(mode == 'edit'), list="capability-options") }}
                            {% if capability_options %}
                            <datalist id="capability-options">
                                {% for cap in capability_options %}
                                <option value="{{ cap }}">{{ cap }}</option>
                                {% endfor %}
                            </datalist>
                            <p class="mt-1 text-xs text-gray-500">可用能力：{{ capability_options|join(', ') }}</p>
                            {% endif %}
                            {% if form.analysis_method_id.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.analysis_method_id.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 設定名稱 -->
                    <div class="sm:col-span-4">
                        <label for="config_name" class="block text-sm font-medium leading-6 text-gray-900">
                            設定名稱 <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-2">
                            {{ form.config_name(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6") }}
                            {% if form.config_name.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.config_name.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 描述 -->
                    <div class="col-span-full">
                        <label for="description" class="block text-sm font-medium leading-6 text-gray-900">
                            描述
                        </label>
                        <div class="mt-2">
                            {{ form.description(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", rows=3) }}
                            {% if form.description.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.description.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 參數 JSON -->
                    <div class="col-span-full">
                        <label for="parameters" class="block text-sm font-medium leading-6 text-gray-900">
                            參數設定（JSON 格式）
                        </label>
                        <div class="mt-2">
                            {{ form.parameters(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 font-mono") }}
                            {% if form.parameters.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.parameters.errors[0] }}</p>
                            {% endif %}
                            <p class="mt-2 text-sm text-gray-500">請輸入有效的 JSON 格式資料</p>
                        </div>
                    </div>

                    <!-- 啟用狀態 -->
                    <div class="sm:col-span-4">
                        <div class="flex items-center">
                            {{ form.enabled(class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600") }}
                            <label for="enabled" class="ml-2 block text-sm text-gray-900">
                                啟用此設定
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分類方法與模型檔案區塊 -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="px-4 py-6 sm:p-8">
                <h3 class="text-base font-semibold leading-7 text-gray-900">分類方法與模型設定</h3>
                <p class="mt-1 text-sm leading-6 text-gray-600">選擇分類方法後，請上傳對應的模型檔案。</p>

                <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <!-- 分類方法選擇 -->
                    <div class="sm:col-span-4">
                        <label for="classification_method" class="block text-sm font-medium leading-6 text-gray-900">
                            分類方法
                        </label>
                        <div class="mt-2">
                            <select id="classification_method" name="classification_method"
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                {% for method_key, method_info in model_requirements.items() %}
                                <option value="{{ method_key }}"
                                    {% if config and config.model_files and config.model_files.get('classification_method') == method_key %}selected{% endif %}
                                    {% if not config and method_key == 'random' %}selected{% endif %}>
                                    {{ method_info.description }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- 模型檔案上傳區塊 -->
                    <div class="col-span-full" id="model-files-section">
                        <div id="model-files-container" class="space-y-4">
                            <!-- 動態產生的模型檔案上傳區塊 -->
                        </div>

                        <!-- 驗證狀態提示 -->
                        <div id="validation-status" class="mt-4 hidden">
                            <div class="rounded-md bg-yellow-50 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">缺少必要模型檔案</h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p id="validation-message">請上傳所有必要的模型檔案後才能儲存設定。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按鈕 -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="flex items-center justify-end gap-x-6 border-t border-gray-900/10 px-4 py-4 sm:px-8">
                <a href="{{ url_for('views.configs_list') }}" class="text-sm font-semibold leading-6 text-gray-900">
                    取消
                </a>
                <button type="submit" id="submit-btn" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-save mr-1"></i> 儲存
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// 模型需求資料
const MODEL_REQUIREMENTS = {{ model_requirements|tojson|safe }};

// 目前已上傳的檔案狀態
let uploadedFiles = {};

{% if config and config.model_files and config.model_files.files %}
uploadedFiles = {{ config.model_files.files|tojson|safe }};
{% endif %}

// 目前設定 ID（編輯模式）
const configId = {% if config %}'{{ config.config_id }}'{% else %}null{% endif %};
const isEditMode = {% if mode == 'edit' %}true{% else %}false{% endif %};

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    const methodSelect = document.getElementById('classification_method');

    // 監聽分類方法變更
    methodSelect.addEventListener('change', function() {
        updateModelFilesUI(this.value);
        validateForm();
    });

    // 初始化顯示
    updateModelFilesUI(methodSelect.value);
    validateForm();
});

// 更新模型檔案 UI
function updateModelFilesUI(method) {
    const container = document.getElementById('model-files-container');
    const requirements = MODEL_REQUIREMENTS[method];

    if (!requirements) {
        container.innerHTML = '';
        return;
    }

    const requiredFiles = requirements.required_files || [];
    const optionalFiles = requirements.optional_files || [];

    if (requiredFiles.length === 0 && optionalFiles.length === 0) {
        container.innerHTML = `
            <div class="rounded-md bg-green-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">此分類方法不需要模型檔案</p>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    let html = '';

    // 必要檔案區塊
    if (requiredFiles.length > 0) {
        html += `
            <div class="border-l-4 border-red-400 bg-red-50 p-4">
                <h4 class="text-sm font-medium text-red-800 mb-3">
                    <i class="fas fa-asterisk mr-1"></i> 必要檔案
                </h4>
                <div class="space-y-3">
        `;

        for (const file of requiredFiles) {
            html += createFileUploadRow(file, true);
        }

        html += `
                </div>
            </div>
        `;
    }

    // 選用檔案區塊
    if (optionalFiles.length > 0) {
        html += `
            <div class="border-l-4 border-gray-300 bg-gray-50 p-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-folder-open mr-1"></i> 選用檔案
                </h4>
                <div class="space-y-3">
        `;

        for (const file of optionalFiles) {
            html += createFileUploadRow(file, false);
        }

        html += `
                </div>
            </div>
        `;
    }

    container.innerHTML = html;

    // 綁定上傳事件
    bindUploadEvents();
}

// 建立檔案上傳列
function createFileUploadRow(fileInfo, isRequired) {
    const fileKey = fileInfo.key;
    const uploaded = uploadedFiles[fileKey];
    const extensions = fileInfo.extensions.join(', ');

    let statusHtml = '';
    let actionHtml = '';

    if (uploaded && uploaded.file_id) {
        statusHtml = `
            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                <i class="fas fa-check mr-1"></i> 已上傳
            </span>
            <span class="text-xs text-gray-500 ml-2">${uploaded.filename || fileInfo.filename}</span>
        `;
        actionHtml = `
            <button type="button" onclick="deleteModelFile('${fileKey}')" class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i> 刪除
            </button>
        `;
    } else {
        statusHtml = `
            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">
                <i class="fas fa-clock mr-1"></i> 未上傳
            </span>
        `;
        actionHtml = `
            <input type="file" id="file-${fileKey}" accept="${fileInfo.extensions.join(',')}" class="hidden" data-file-key="${fileKey}">
            <button type="button" onclick="document.getElementById('file-${fileKey}').click()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-upload"></i> 上傳
            </button>
        `;
    }

    return `
        <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0" id="row-${fileKey}">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">
                    ${fileInfo.description}
                    ${isRequired ? '<span class="text-red-500">*</span>' : ''}
                </p>
                <p class="text-xs text-gray-500">預設檔名: ${fileInfo.filename} (${extensions})</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="status-${fileKey}">${statusHtml}</div>
                <div id="action-${fileKey}">${actionHtml}</div>
            </div>
        </div>
    `;
}

// 綁定上傳事件
function bindUploadEvents() {
    document.querySelectorAll('input[type="file"][data-file-key]').forEach(input => {
        input.addEventListener('change', async function() {
            const fileKey = this.dataset.fileKey;
            const file = this.files[0];
            if (file) {
                await uploadModelFile(fileKey, file);
            }
        });
    });
}

// 上傳模型檔案
async function uploadModelFile(fileKey, file) {
    if (!configId) {
        alert('請先儲存設定後再上傳模型檔案');
        return;
    }

    const statusEl = document.getElementById(`status-${fileKey}`);
    const actionEl = document.getElementById(`action-${fileKey}`);

    // 顯示上傳中狀態
    statusEl.innerHTML = `
        <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
            <i class="fas fa-spinner fa-spin mr-1"></i> 上傳中...
        </span>
    `;
    actionEl.innerHTML = '';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`/api/configs/${configId}/model/${fileKey}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // 更新已上傳狀態
            uploadedFiles[fileKey] = result.file_info;

            statusEl.innerHTML = `
                <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                    <i class="fas fa-check mr-1"></i> 已上傳
                </span>
                <span class="text-xs text-gray-500 ml-2">${file.name}</span>
            `;
            actionEl.innerHTML = `
                <button type="button" onclick="deleteModelFile('${fileKey}')" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash"></i> 刪除
                </button>
            `;

            validateForm();
        } else {
            throw new Error(result.message || '上傳失敗');
        }
    } catch (error) {
        statusEl.innerHTML = `
            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                <i class="fas fa-times mr-1"></i> 上傳失敗
            </span>
        `;
        actionEl.innerHTML = `
            <input type="file" id="file-${fileKey}" class="hidden" data-file-key="${fileKey}">
            <button type="button" onclick="document.getElementById('file-${fileKey}').click()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-upload"></i> 重試
            </button>
        `;
        bindUploadEvents();
        alert('上傳失敗: ' + error.message);
    }
}

// 刪除模型檔案
async function deleteModelFile(fileKey) {
    if (!configId) return;

    if (!confirm('確定要刪除此模型檔案嗎？')) return;

    const statusEl = document.getElementById(`status-${fileKey}`);
    const actionEl = document.getElementById(`action-${fileKey}`);

    // 顯示刪除中狀態
    statusEl.innerHTML = `
        <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
            <i class="fas fa-spinner fa-spin mr-1"></i> 刪除中...
        </span>
    `;

    try {
        const response = await fetch(`/api/configs/${configId}/model/${fileKey}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            delete uploadedFiles[fileKey];

            // 重新渲染該列
            const method = document.getElementById('classification_method').value;
            updateModelFilesUI(method);
            validateForm();
        } else {
            throw new Error(result.message || '刪除失敗');
        }
    } catch (error) {
        alert('刪除失敗: ' + error.message);
        const method = document.getElementById('classification_method').value;
        updateModelFilesUI(method);
    }
}

// 驗證表單
function validateForm() {
    const method = document.getElementById('classification_method').value;
    const requirements = MODEL_REQUIREMENTS[method];
    const submitBtn = document.getElementById('submit-btn');
    const validationStatus = document.getElementById('validation-status');
    const validationMessage = document.getElementById('validation-message');

    if (!requirements) {
        submitBtn.disabled = false;
        validationStatus.classList.add('hidden');
        return;
    }

    const requiredFiles = requirements.required_files || [];

    // 檢查所有必要檔案是否已上傳
    const missingFiles = [];
    for (const file of requiredFiles) {
        const uploaded = uploadedFiles[file.key];
        if (!uploaded || !uploaded.file_id) {
            missingFiles.push(file.description);
        }
    }

    if (missingFiles.length > 0 && isEditMode) {
        submitBtn.disabled = true;
        validationStatus.classList.remove('hidden');
        validationMessage.textContent = `缺少以下必要檔案：${missingFiles.join('、')}`;
    } else {
        submitBtn.disabled = false;
        validationStatus.classList.add('hidden');
    }
}

// 表單提交前更新分類方法
document.getElementById('config-form').addEventListener('submit', async function(e) {
    const method = document.getElementById('classification_method').value;

    // 如果是編輯模式，先更新分類方法
    if (isEditMode && configId) {
        e.preventDefault();

        try {
            const response = await fetch(`/api/configs/${configId}/method`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ method: method })
            });

            const result = await response.json();

            if (result.success) {
                // 繼續提交表單
                this.submit();
            } else {
                alert('更新分類方法失敗: ' + (result.message || '未知錯誤'));
            }
        } catch (error) {
            alert('更新分類方法失敗: ' + error.message);
        }
    }
});
</script>
{% endblock %}
