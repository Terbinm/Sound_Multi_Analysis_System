{% extends "base.html" %}

{% block title %}{% if mode == 'create' %}建立配置{% else %}編輯配置{% endif %}{% endblock %}
{% block page_title %}{% if mode == 'create' %}建立分析配置{% else %}編輯分析配置{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl space-y-4">
    <!-- Info Banner -->
    <div class="rounded-lg border border-indigo-100 bg-indigo-50/80 p-4 text-sm text-indigo-900">
        <p class="font-semibold">配置說明</p>
        <ul class="mt-2 list-disc space-y-1 pl-5">
            <li><span class="font-semibold">分析方法 ID</span> 為必填，且必須與分析節點的路由金鑰相符。</li>
            <li><span class="font-semibold">分類方法</span> 決定使用哪個模型。非隨機方法需要模型檔案。</li>
            <li><span class="font-semibold">參數</span> 會根據所選方法自動產生。</li>
        </ul>
        <p class="mt-2 text-xs text-indigo-700">
            Schema 版本: <span id="schema-version" class="font-mono">載入中...</span>
            | 雜湊值: <span id="schema-hash" class="font-mono">載入中...</span>
        </p>
    </div>

    <form method="POST" class="space-y-6" id="config-form">
        {{ form.hidden_tag() }}

        <!-- Basic Info Section -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="px-4 py-6 sm:p-8">
                <h3 class="text-base font-semibold leading-7 text-gray-900 mb-6">基本資訊</h3>
                <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <!-- Analysis Method ID -->
                    <div class="sm:col-span-4">
                        <label for="analysis_method_id" class="block text-sm font-medium leading-6 text-gray-900">
                            分析方法 ID <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-2">
                            {% if mode == 'edit' %}
                            <!-- 編輯模式：唯讀顯示 -->
                            {{ form.analysis_method_id(class="block w-full rounded-md border-0 py-1.5 shadow-sm ring-1 ring-inset ring-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed sm:text-sm sm:leading-6", readonly=true) }}
                            {% else %}
                            <!-- 新建模式：可輸入的下拉選單 -->
                            <div class="relative">
                                <input type="text"
                                       id="analysis_method_id"
                                       name="analysis_method_id"
                                       value="{{ form.analysis_method_id.data or '' }}"
                                       class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 pr-10"
                                       placeholder="選擇或輸入分析方法 ID"
                                       autocomplete="off"
                                       required>
                                <button type="button"
                                        id="method-dropdown-btn"
                                        class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <!-- 下拉選單 -->
                                <div id="method-dropdown" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                    {% if capability_options %}
                                    {% for cap in capability_options %}
                                    <div class="method-option cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-50" data-value="{{ cap }}">
                                        <span class="block truncate">{{ cap }}</span>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="py-2 pl-3 pr-9 text-gray-500">
                                        <span class="block truncate">尚無可用的分析方法，請直接輸入</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if capability_options %}
                            <p class="mt-1 text-xs text-gray-500">可用功能: {{ capability_options|join(', ') }}</p>
                            {% endif %}
                            {% if form.analysis_method_id.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.analysis_method_id.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Config Name -->
                    <div class="sm:col-span-4">
                        <label for="config_name" class="block text-sm font-medium leading-6 text-gray-900">
                            配置名稱 <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-2">
                            {{ form.config_name(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6") }}
                            {% if form.config_name.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.config_name.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="col-span-full">
                        <label for="description" class="block text-sm font-medium leading-6 text-gray-900">
                            說明
                        </label>
                        <div class="mt-2">
                            {{ form.description(class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", rows=2) }}
                        </div>
                    </div>

                    <!-- Enabled -->
                    <div class="sm:col-span-4">
                        <div class="flex items-center">
                            {{ form.enabled(class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600") }}
                            <label for="enabled" class="ml-2 block text-sm text-gray-900">
                                啟用此配置
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classification Method Section -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="px-4 py-6 sm:p-8">
                <h3 class="text-base font-semibold leading-7 text-gray-900">分類方法</h3>
                <p class="mt-1 text-sm leading-6 text-gray-600">選擇分類方法並配置其參數。</p>

                <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                    <!-- Classification Method Select -->
                    <div class="sm:col-span-4">
                        <label for="classification_method" class="block text-sm font-medium leading-6 text-gray-900">
                            分類方法
                        </label>
                        <div class="mt-2">
                            <select id="classification_method" name="classification_method"
                                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <p id="method-description" class="mt-1 text-xs text-gray-500"></p>
                            <p id="method-version" class="mt-1 text-xs text-gray-400"></p>
                        </div>
                    </div>

                    <!-- Method-specific Parameters -->
                    <div class="col-span-full" id="method-params-section">
                        <div class="border-l-4 border-indigo-400 bg-indigo-50 p-4">
                            <h4 class="text-sm font-medium text-indigo-800 mb-3">
                                <i class="fas fa-sliders-h mr-1"></i> 方法參數
                            </h4>
                            <div id="method-params-container" class="space-y-4">
                                <!-- Dynamically generated method-specific parameters -->
                            </div>
                        </div>
                    </div>

                    <!-- Model Files Upload -->
                    <div class="col-span-full" id="model-files-section">
                        <div id="model-files-container" class="space-y-4">
                            <!-- Dynamically generated model file upload sections -->
                        </div>

                        <!-- Validation Status -->
                        <div id="validation-status" class="mt-4 hidden">
                            <div class="rounded-md bg-yellow-50 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">缺少必要的模型檔案</h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p id="validation-message">請在儲存前上傳所有必要的模型檔案。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parameter Groups Section -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="px-4 py-6 sm:p-8">
                <h3 class="text-base font-semibold leading-7 text-gray-900">分析參數</h3>
                <p class="mt-1 text-sm leading-6 text-gray-600">配置每個分析步驟的處理參數。</p>

                <div id="parameter-groups-container" class="mt-6 space-y-6">
                    <!-- Dynamically generated parameter groups -->
                </div>
            </div>
        </div>

        <!-- Hidden field for parameters JSON -->
        <input type="hidden" id="parameters" name="parameters" value="{{ form.parameters.data or '{}' }}">

        <!-- Hidden fields for temp upload data (新建模式使用) -->
        <input type="hidden" id="temp_session_id" name="temp_session_id" value="">
        <input type="hidden" id="temp_files" name="temp_files" value="{}">

        <!-- Submit Buttons -->
        <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
            <div class="flex items-center justify-end gap-x-6 border-t border-gray-900/10 px-4 py-4 sm:px-8">
                <a href="{{ url_for('views.configs_list') }}" class="text-sm font-semibold leading-6 text-gray-900">
                    取消
                </a>
                <button type="submit" id="submit-btn" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-save mr-1"></i> 儲存
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// ==================== Global State ====================
let SCHEMA = null;
let uploadedFiles = {};
let currentParameters = {};
let tempUploadedFiles = {};  // 暫存上傳的檔案 {file_key: {file_id, filename, ...}}
let tempSessionId = null;    // 暫存上傳的 session ID

{% if config and config.model_files and config.model_files.files %}
uploadedFiles = {{ config.model_files.files|tojson|safe }};
{% endif %}

{% if config and config.parameters %}
currentParameters = {{ config.parameters|tojson|safe }};
{% endif %}

const configId = {% if config %}'{{ config.config_id }}'{% else %}null{% endif %};
const isEditMode = {% if mode == 'edit' %}true{% else %}false{% endif %};
const currentMethod = {% if config and config.model_files %}'{{ config.model_files.classification_method or "random" }}'{% else %}'random'{% endif %};

// ==================== Initialization ====================
document.addEventListener('DOMContentLoaded', async function() {
    await loadSchema();
    initializeForm();
    initializeMethodDropdown();
});

// ==================== Method ID Dropdown ====================
function initializeMethodDropdown() {
    if (isEditMode) return;  // 編輯模式不需要下拉選單

    const input = document.getElementById('analysis_method_id');
    const dropdown = document.getElementById('method-dropdown');
    const dropdownBtn = document.getElementById('method-dropdown-btn');

    if (!input || !dropdown || !dropdownBtn) return;

    // 點擊按鈕切換下拉選單
    dropdownBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });

    // 點擊輸入框也顯示下拉選單
    input.addEventListener('focus', function() {
        dropdown.classList.remove('hidden');
    });

    // 選擇選項
    document.querySelectorAll('.method-option').forEach(option => {
        option.addEventListener('click', function() {
            input.value = this.dataset.value;
            dropdown.classList.add('hidden');
            input.dispatchEvent(new Event('change'));
        });
    });

    // 點擊其他地方關閉下拉選單
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });

    // 輸入時過濾選項
    input.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('.method-option').forEach(option => {
            const text = option.dataset.value.toLowerCase();
            option.style.display = text.includes(filter) ? '' : 'none';
        });
    });
}

async function loadSchema() {
    try {
        const response = await fetch('/api/configs/schema');
        const result = await response.json();

        if (result.success) {
            SCHEMA = result.data;
            document.getElementById('schema-version').textContent = SCHEMA.schema_version;
            document.getElementById('schema-hash').textContent = SCHEMA.schema_hash;
        } else {
            console.error('Failed to load schema:', result.error);
            alert('載入配置 Schema 失敗');
        }
    } catch (error) {
        console.error('Error loading schema:', error);
        alert('載入配置 Schema 時發生錯誤');
    }
}

function initializeForm() {
    if (!SCHEMA) return;

    // Populate classification methods
    populateClassificationMethods();

    // Render parameter groups
    renderParameterGroups();

    // Setup event listeners
    document.getElementById('classification_method').addEventListener('change', function() {
        onMethodChange(this.value);
    });

    // Trigger initial render
    onMethodChange(currentMethod);
}

// ==================== Classification Methods ====================
function populateClassificationMethods() {
    const select = document.getElementById('classification_method');
    select.innerHTML = '';

    for (const method of SCHEMA.classification_methods) {
        const option = document.createElement('option');
        option.value = method.key;
        option.textContent = method.label;
        if (method.key === currentMethod) {
            option.selected = true;
        }
        select.appendChild(option);
    }
}

function onMethodChange(methodKey) {
    const method = SCHEMA.classification_methods.find(m => m.key === methodKey);
    if (!method) return;

    // Update description
    document.getElementById('method-description').textContent = method.description;
    document.getElementById('method-version').textContent = `版本: ${method.version}`;

    // Render method-specific parameters
    renderMethodParams(method);

    // Render model files section
    renderModelFiles(method);

    // Validate form
    validateForm();
}

function renderMethodParams(method) {
    const container = document.getElementById('method-params-container');
    const params = method.params || [];

    if (params.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">此方法無額外參數。</p>';
        return;
    }

    let html = '<div class="grid grid-cols-1 gap-4 sm:grid-cols-2">';

    for (const param of params) {
        const currentValue = getParameterValue('method', param.name, param.default);
        html += renderField(param, currentValue, 'method');
    }

    html += '</div>';
    container.innerHTML = html;

    // Bind events
    bindFieldEvents(container);
}

// ==================== Parameter Groups ====================
function renderParameterGroups() {
    const container = document.getElementById('parameter-groups-container');
    let html = '';

    for (const group of SCHEMA.parameter_groups) {
        html += renderParameterGroup(group);
    }

    container.innerHTML = html;

    // Bind collapsible events
    container.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-collapse-toggle');
            const target = document.getElementById(targetId);
            const icon = this.querySelector('i');

            if (target.classList.contains('hidden')) {
                target.classList.remove('hidden');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                target.classList.add('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        });
    });

    // Bind field events
    bindFieldEvents(container);
}

function renderParameterGroup(group) {
    const isCollapsed = group.collapsed !== false;
    const collapseId = `group-${group.key}-content`;

    let html = `
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button type="button" data-collapse-toggle="${collapseId}"
                class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 text-left">
                <div>
                    <span class="text-sm font-medium text-gray-900">${group.label}</span>
                    <span class="ml-2 text-xs text-gray-500">${group.description || ''}</span>
                </div>
                <i class="fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'} text-gray-400"></i>
            </button>
            <div id="${collapseId}" class="${isCollapsed ? 'hidden' : ''} p-4 border-t border-gray-200">
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
    `;

    for (const field of group.fields) {
        const currentValue = getParameterValue(group.key, field.name, field.default);
        html += renderField(field, currentValue, group.key);
    }

    html += `
                </div>
            </div>
        </div>
    `;

    return html;
}

// ==================== Field Rendering ====================
function renderField(field, value, groupKey) {
    const fieldId = `param-${groupKey}-${field.name}`;
    const fieldName = `${groupKey}.${field.name}`;

    let inputHtml = '';

    switch (field.type) {
        case 'number':
            inputHtml = `
                <input type="number" id="${fieldId}" data-group="${groupKey}" data-field="${field.name}"
                    value="${value !== null && value !== undefined ? value : ''}"
                    ${field.min !== undefined ? `min="${field.min}"` : ''}
                    ${field.max !== undefined ? `max="${field.max}"` : ''}
                    ${field.step !== undefined ? `step="${field.step}"` : ''}
                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
            `;
            break;

        case 'select':
            inputHtml = `<select id="${fieldId}" data-group="${groupKey}" data-field="${field.name}"
                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">`;
            for (const opt of field.options) {
                const optValue = typeof opt.value === 'object' ? JSON.stringify(opt.value) : opt.value;
                const currentVal = typeof value === 'object' ? JSON.stringify(value) : value;
                const selected = optValue == currentVal ? 'selected' : '';
                inputHtml += `<option value='${optValue}' ${selected}>${opt.label}</option>`;
            }
            inputHtml += '</select>';
            break;

        case 'boolean':
            inputHtml = `
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="${fieldId}" data-group="${groupKey}" data-field="${field.name}"
                        ${value ? 'checked' : ''}
                        class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-700">${value ? '已啟用' : '已停用'}</span>
                </label>
            `;
            break;

        case 'tags':
            const tagsValue = Array.isArray(value) ? value.join(', ') : (value || '');
            inputHtml = `
                <input type="text" id="${fieldId}" data-group="${groupKey}" data-field="${field.name}" data-type="tags"
                    value="${tagsValue}"
                    placeholder="請輸入以逗號分隔的值"
                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
            `;
            if (field.suggestions) {
                inputHtml += `<p class="mt-1 text-xs text-gray-400">建議: ${field.suggestions.join(', ')}</p>`;
            }
            break;

        default:
            inputHtml = `
                <input type="text" id="${fieldId}" data-group="${groupKey}" data-field="${field.name}"
                    value="${value !== null && value !== undefined ? value : ''}"
                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
            `;
    }

    return `
        <div class="space-y-1">
            <label for="${fieldId}" class="block text-sm font-medium text-gray-700">
                ${field.label}
            </label>
            ${inputHtml}
            ${field.description ? `<p class="text-xs text-gray-500">${field.description}</p>` : ''}
        </div>
    `;
}

function bindFieldEvents(container) {
    container.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', function() {
            updateParameterValue(this);
        });
    });
}

// ==================== Parameter Value Management ====================
function getParameterValue(groupKey, fieldName, defaultValue) {
    if (groupKey === 'method') {
        // Method-specific params stored in classification group
        const classificationParams = currentParameters.classification || {};
        return classificationParams[fieldName] !== undefined ? classificationParams[fieldName] : defaultValue;
    }

    const groupParams = currentParameters[groupKey] || {};
    return groupParams[fieldName] !== undefined ? groupParams[fieldName] : defaultValue;
}

function updateParameterValue(element) {
    const groupKey = element.dataset.group;
    const fieldName = element.dataset.field;
    const fieldType = element.dataset.type;

    let value;

    if (element.type === 'checkbox') {
        value = element.checked;
        // Update toggle label
        const label = element.parentElement.querySelector('span');
        if (label) label.textContent = value ? '已啟用' : '已停用';
    } else if (element.type === 'number') {
        value = element.value === '' ? null : parseFloat(element.value);
    } else if (fieldType === 'tags') {
        value = element.value.split(',').map(s => s.trim()).filter(s => s);
    } else {
        // Try to parse JSON for select values that might be arrays/objects
        try {
            value = JSON.parse(element.value);
        } catch {
            value = element.value;
        }
    }

    // Store value
    const targetGroup = groupKey === 'method' ? 'classification' : groupKey;
    if (!currentParameters[targetGroup]) {
        currentParameters[targetGroup] = {};
    }
    currentParameters[targetGroup][fieldName] = value;

    // Update hidden field
    document.getElementById('parameters').value = JSON.stringify(currentParameters);
}

// ==================== Model Files ====================
function renderModelFiles(method) {
    const container = document.getElementById('model-files-container');
    const requiredModels = method.required_models || [];
    const optionalModels = method.optional_models || [];

    if (requiredModels.length === 0 && optionalModels.length === 0) {
        container.innerHTML = `
            <div class="rounded-md bg-green-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">此方法不需要模型檔案</p>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    let html = '';

    // Required files
    if (requiredModels.length > 0) {
        html += `
            <div class="border-l-4 border-red-400 bg-red-50 p-4">
                <h4 class="text-sm font-medium text-red-800 mb-3">
                    <i class="fas fa-asterisk mr-1"></i> 必要檔案
                </h4>
                <div class="space-y-3">
        `;
        for (const modelKey of requiredModels) {
            const modelDef = SCHEMA.model_files[modelKey];
            if (modelDef) {
                html += createFileUploadRow(modelDef, true);
            }
        }
        html += '</div></div>';
    }

    // Optional files
    if (optionalModels.length > 0) {
        html += `
            <div class="border-l-4 border-gray-300 bg-gray-50 p-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-folder-open mr-1"></i> 選用檔案
                </h4>
                <div class="space-y-3">
        `;
        for (const modelKey of optionalModels) {
            const modelDef = SCHEMA.model_files[modelKey];
            if (modelDef) {
                html += createFileUploadRow(modelDef, false);
            }
        }
        html += '</div></div>';
    }

    container.innerHTML = html;
    bindUploadEvents();
}

function createFileUploadRow(fileInfo, isRequired) {
    const fileKey = fileInfo.key;
    const uploaded = uploadedFiles[fileKey];
    const tempUploaded = tempUploadedFiles[fileKey];
    const extensions = fileInfo.extensions.join(', ');

    let statusHtml = '';
    let actionHtml = '';

    if (uploaded && uploaded.file_id) {
        // 正式上傳的檔案
        statusHtml = `
            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                <i class="fas fa-check mr-1"></i> 已上傳
            </span>
            <span class="text-xs text-gray-500 ml-2">${uploaded.filename || fileInfo.filename}</span>
        `;
        actionHtml = `
            <button type="button" onclick="deleteModelFile('${fileKey}')" class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i> 刪除
            </button>
        `;
    } else if (tempUploaded && tempUploaded.file_id) {
        // 暫存的檔案
        statusHtml = `
            <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
                <i class="fas fa-clock mr-1"></i> 已暫存
            </span>
            <span class="text-xs text-gray-500 ml-2">${tempUploaded.filename || fileInfo.filename}</span>
        `;
        actionHtml = `
            <button type="button" onclick="deleteModelFile('${fileKey}')" class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i> 刪除
            </button>
        `;
    } else {
        statusHtml = `
            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">
                <i class="fas fa-clock mr-1"></i> 未上傳
            </span>
        `;
        actionHtml = `
            <input type="file" id="file-${fileKey}" accept="${fileInfo.extensions.join(',')}" class="hidden" data-file-key="${fileKey}">
            <button type="button" onclick="document.getElementById('file-${fileKey}').click()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-upload"></i> 上傳
            </button>
        `;
    }

    return `
        <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0" id="row-${fileKey}">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">
                    ${fileInfo.label || fileInfo.description}
                    ${isRequired ? '<span class="text-red-500">*</span>' : ''}
                </p>
                <p class="text-xs text-gray-500">預設: ${fileInfo.filename} (${extensions})</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="status-${fileKey}">${statusHtml}</div>
                <div id="action-${fileKey}">${actionHtml}</div>
            </div>
        </div>
    `;
}

function bindUploadEvents() {
    document.querySelectorAll('input[type="file"][data-file-key]').forEach(input => {
        input.addEventListener('change', async function() {
            const fileKey = this.dataset.fileKey;
            const file = this.files[0];
            if (file) {
                await uploadModelFile(fileKey, file);
            }
        });
    });
}

async function uploadModelFile(fileKey, file) {
    const statusEl = document.getElementById(`status-${fileKey}`);
    const actionEl = document.getElementById(`action-${fileKey}`);

    statusEl.innerHTML = `
        <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
            <i class="fas fa-spinner fa-spin mr-1"></i> 上傳中...
        </span>
    `;
    actionEl.innerHTML = '';

    try {
        const formData = new FormData();
        formData.append('file', file);

        let apiUrl;
        if (configId) {
            // 編輯模式：直接上傳到配置
            apiUrl = `/api/configs/${configId}/model/${fileKey}`;
        } else {
            // 新建模式：暫存上傳
            apiUrl = `/api/configs/temp-upload/${fileKey}`;
            if (tempSessionId) {
                formData.append('session_id', tempSessionId);
            }
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            if (configId) {
                // 編輯模式
                uploadedFiles[fileKey] = result.data;
            } else {
                // 新建模式：保存暫存資訊
                tempUploadedFiles[fileKey] = result.data;
                if (result.data.session_id) {
                    tempSessionId = result.data.session_id;
                }
            }

            statusEl.innerHTML = `
                <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                    <i class="fas fa-check mr-1"></i> ${configId ? '已上傳' : '已暫存'}
                </span>
                <span class="text-xs text-gray-500 ml-2">${file.name}</span>
            `;
            actionEl.innerHTML = `
                <button type="button" onclick="deleteModelFile('${fileKey}')" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash"></i> 刪除
                </button>
            `;

            validateForm();
        } else {
            throw new Error(result.error || '上傳失敗');
        }
    } catch (error) {
        statusEl.innerHTML = `
            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                <i class="fas fa-times mr-1"></i> 失敗
            </span>
        `;
        actionEl.innerHTML = `
            <input type="file" id="file-${fileKey}" class="hidden" data-file-key="${fileKey}">
            <button type="button" onclick="document.getElementById('file-${fileKey}').click()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-upload"></i> 重試
            </button>
        `;
        bindUploadEvents();
        alert('上傳失敗: ' + error.message);
    }
}

async function deleteModelFile(fileKey) {
    if (!confirm('確定要刪除此模型檔案嗎？')) return;

    const statusEl = document.getElementById(`status-${fileKey}`);
    statusEl.innerHTML = `
        <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
            <i class="fas fa-spinner fa-spin mr-1"></i> 刪除中...
        </span>
    `;

    try {
        let apiUrl;
        if (configId) {
            // 編輯模式
            apiUrl = `/api/configs/${configId}/model/${fileKey}`;
        } else {
            // 新建模式：刪除暫存檔案
            const tempFile = tempUploadedFiles[fileKey];
            if (!tempFile || !tempFile.file_id) {
                throw new Error('找不到暫存檔案');
            }
            apiUrl = `/api/configs/temp-upload/${fileKey}?file_id=${tempFile.file_id}`;
            if (tempSessionId) {
                apiUrl += `&session_id=${tempSessionId}`;
            }
        }

        const response = await fetch(apiUrl, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            if (configId) {
                delete uploadedFiles[fileKey];
            } else {
                delete tempUploadedFiles[fileKey];
            }
            const method = document.getElementById('classification_method').value;
            const methodDef = SCHEMA.classification_methods.find(m => m.key === method);
            renderModelFiles(methodDef);
            validateForm();
        } else {
            throw new Error(result.error || '刪除失敗');
        }
    } catch (error) {
        alert('刪除失敗: ' + error.message);
        const method = document.getElementById('classification_method').value;
        const methodDef = SCHEMA.classification_methods.find(m => m.key === method);
        renderModelFiles(methodDef);
    }
}

// ==================== Form Validation ====================
function validateForm() {
    const method = document.getElementById('classification_method').value;
    const methodDef = SCHEMA.classification_methods.find(m => m.key === method);
    const submitBtn = document.getElementById('submit-btn');
    const validationStatus = document.getElementById('validation-status');
    const validationMessage = document.getElementById('validation-message');

    if (!methodDef) {
        submitBtn.disabled = false;
        validationStatus.classList.add('hidden');
        return;
    }

    const requiredModels = methodDef.required_models || [];

    // Check all required files are uploaded (檢查正式上傳和暫存上傳)
    const missingFiles = [];
    for (const modelKey of requiredModels) {
        const uploaded = uploadedFiles[modelKey];
        const tempUploaded = tempUploadedFiles[modelKey];

        // 檢查是否有正式上傳或暫存上傳
        const hasFile = (uploaded && uploaded.file_id) || (tempUploaded && tempUploaded.file_id);

        if (!hasFile) {
            const modelDef = SCHEMA.model_files[modelKey];
            missingFiles.push(modelDef ? modelDef.label : modelKey);
        }
    }

    if (missingFiles.length > 0) {
        submitBtn.disabled = true;
        validationStatus.classList.remove('hidden');
        validationMessage.textContent = `缺少必要檔案: ${missingFiles.join(', ')}`;
    } else {
        submitBtn.disabled = false;
        validationStatus.classList.add('hidden');
    }
}

// ==================== Form Submission ====================
document.getElementById('config-form').addEventListener('submit', async function(e) {
    const method = document.getElementById('classification_method').value;

    // Ensure parameters are updated
    document.getElementById('parameters').value = JSON.stringify(currentParameters);

    // 更新暫存上傳資訊（新建模式）
    if (!isEditMode && Object.keys(tempUploadedFiles).length > 0) {
        document.getElementById('temp_session_id').value = tempSessionId || '';
        // 建立 file_key -> file_id 的映射
        const tempFilesMap = {};
        for (const [key, info] of Object.entries(tempUploadedFiles)) {
            if (info && info.file_id) {
                tempFilesMap[key] = info.file_id;
            }
        }
        document.getElementById('temp_files').value = JSON.stringify(tempFilesMap);
    }

    // If edit mode, update classification method first
    if (isEditMode && configId) {
        e.preventDefault();

        try {
            const response = await fetch(`/api/configs/${configId}/method`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ method: method })
            });

            const result = await response.json();

            if (result.success) {
                this.submit();
            } else {
                alert('更新分類方法失敗: ' + (result.error || '未知錯誤'));
            }
        } catch (error) {
            alert('更新分類方法失敗: ' + error.message);
        }
    }
});
</script>
{% endblock %}
