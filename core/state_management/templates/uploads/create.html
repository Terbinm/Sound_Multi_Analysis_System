{% extends "base.html" %}

{% block title %}檔案上傳{% endblock %}

{% block page_title %}檔案上傳與分析{% endblock %}

{% block extra_css %}
<style>
    .dropzone {
        border: 2px dashed #cbd5e0;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    .dropzone.drag-over {
        border-color: #4f46e5;
        background-color: #eef2ff;
    }
    .file-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .router-card {
        transition: all 0.2s ease;
    }
    .router-card.selected {
        border-color: #4f46e5;
        background-color: #eef2ff;
    }
    .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e5e7eb;
        color: #6b7280;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .step-indicator.active {
        background-color: #4f46e5;
        color: white;
    }
    .step-indicator.completed {
        background-color: #10b981;
        color: white;
    }
    .step-connector {
        flex: 1;
        height: 2px;
        background-color: #e5e7eb;
        margin: 0 1rem;
        transition: all 0.3s ease;
    }
    .step-connector.completed {
        background-color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto parallax-container" x-data="uploadForm()">

    {# 步驟指示器 #}
    <div class="tech-card parallax-layer parallax-layer1 mb-6">
        <div class="px-6 py-6">
            <div class="flex items-center justify-between">
                {# 步驟 1 #}
                <div class="flex flex-col items-center">
                    <div class="step-indicator" :class="{
                        'active': currentStep === 1,
                        'completed': currentStep > 1
                    }">
                        <span x-show="currentStep <= 1">1</span>
                        <i class="fas fa-check" x-show="currentStep > 1"></i>
                    </div>
                    <span class="text-sm mt-2 font-medium" :class="currentStep === 1 ? 'text-blue-600' : 'text-gray-600'">
                        上傳檔案
                    </span>
                </div>

                <div class="step-connector" :class="{ 'completed': currentStep > 1 }"></div>

                {# 步驟 2 #}
                <div class="flex flex-col items-center">
                    <div class="step-indicator" :class="{
                        'active': currentStep === 2,
                        'completed': currentStep > 2
                    }">
                        <span x-show="currentStep <= 2">2</span>
                        <i class="fas fa-check" x-show="currentStep > 2"></i>
                    </div>
                    <span class="text-sm mt-2 font-medium" :class="currentStep === 2 ? 'text-blue-600' : 'text-gray-600'">
                        選擇路由
                    </span>
                </div>

                <div class="step-connector" :class="{ 'completed': currentStep > 2 }"></div>

                {# 步驟 3 #}
                <div class="flex flex-col items-center">
                    <div class="step-indicator" :class="{
                        'active': currentStep === 3,
                        'completed': currentStep > 3
                    }">
                        <span x-show="currentStep <= 3">3</span>
                        <i class="fas fa-check" x-show="currentStep > 3"></i>
                    </div>
                    <span class="text-sm mt-2 font-medium" :class="currentStep === 3 ? 'text-blue-600' : 'text-gray-600'">
                        填寫資訊
                    </span>
                </div>

                <div class="step-connector" :class="{ 'completed': currentStep > 3 }"></div>

                {# 步驟 4 #}
                <div class="flex flex-col items-center">
                    <div class="step-indicator" :class="{
                        'active': currentStep === 4,
                        'completed': currentStep > 4
                    }">
                        <span x-show="currentStep <= 4">4</span>
                        <i class="fas fa-check" x-show="currentStep > 4"></i>
                    </div>
                    <span class="text-sm mt-2 font-medium" :class="currentStep === 4 ? 'text-blue-600' : 'text-gray-600'">
                        確認提交
                    </span>
                </div>
            </div>
        </div>
    </div>

    {# 步驟 1: 上傳檔案 #}
    <div x-show="currentStep === 1" class="wizard-step">
        <div class="tech-card parallax-layer parallax-layer2">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="text-lg font-semibold text-gray-900">步驟 1：上傳音訊檔案</h3>
                <p class="text-sm text-gray-600 mt-1">支援格式: WAV, MP3, M4A, FLAC, OGG, AAC</p>
            </div>

            <div class="px-6 py-6">
                {# 拖放上傳區 #}
                <div class="dropzone p-12 text-center cursor-pointer"
                     :class="{ 'drag-over': isDragging }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleDrop">
                    
                    <input type="file" 
                           id="fileInput" 
                           class="hidden" 
                           accept=".wav,.mp3,.m4a,.flac,.ogg,.aac"
                           @change="handleFileSelect">
                    
                    <div x-show="!selectedFile">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-medium text-gray-700 mb-2">拖放檔案至此處</p>
                        <p class="text-sm text-gray-500 mb-4">或</p>
                        <button type="button" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                @click="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open mr-2"></i>瀏覽檔案
                        </button>
                        <p class="text-xs text-gray-500 mt-4">最大檔案大小: <span x-text="maxFileSizeMB"></span> MB</p>
                    </div>

                    <div x-show="selectedFile" class="file-preview p-6 rounded-lg">
                        <i class="fas fa-file-audio text-5xl mb-4"></i>
                        <p class="text-xl font-semibold mb-2" x-text="selectedFile?.name"></p>
                        <p class="text-sm mb-4">
                            大小: <span x-text="formatFileSize(selectedFile?.size)"></span>
                        </p>
                        <button type="button" 
                                class="px-4 py-2 bg-white text-purple-700 rounded-lg hover:bg-gray-100 transition"
                                @click="clearFile">
                            <i class="fas fa-times mr-2"></i>移除檔案
                        </button>
                    </div>
                </div>

                {# 錯誤訊息 #}
                <div x-show="errors.file" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600" x-text="errors.file"></p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-end">
                <button type="button" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="!selectedFile"
                        @click="nextStep">
                    下一步 <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    {# 步驟 2: 選擇路由規則 #}
    <div x-show="currentStep === 2" class="wizard-step">
        <div class="tech-card parallax-layer parallax-layer2">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="text-lg font-semibold text-gray-900">步驟 2：選擇分析路由</h3>
                <p class="text-sm text-gray-600 mt-1">至少選擇一個路由規則進行分析</p>
            </div>

            <div class="px-6 py-6">
                {# 執行模式選擇 #}
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-3">執行模式</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" 
                                   name="sequential" 
                                   value="true" 
                                   x-model="sequential" 
                                   class="mr-2">
                            <span class="text-sm">
                                <i class="fas fa-list-ol mr-1 text-blue-600"></i>串行執行（依序執行，確保順序）
                            </span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" 
                                   name="sequential" 
                                   value="false" 
                                   x-model="sequential" 
                                   class="mr-2">
                            <span class="text-sm">
                                <i class="fas fa-bars-staggered mr-1 text-green-600"></i>並行執行（同時執行，速度較快）
                            </span>
                        </label>
                    </div>
                </div>

                {# 路由規則卡片列表 #}
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <template x-for="router in availableRouters" :key="router.rule_id">
                        <div class="router-card p-4 border-2 rounded-lg cursor-pointer"
                             :class="{ 'selected': selectedRouters.includes(router.rule_id) }"
                             @click="toggleRouter(router.rule_id)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" 
                                               :checked="selectedRouters.includes(router.rule_id)"
                                               @click.stop="toggleRouter(router.rule_id)"
                                               class="mr-3">
                                        <h4 class="font-semibold text-gray-900" x-text="router.rule_name"></h4>
                                        <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                                            優先級: <span x-text="router.priority"></span>
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3" x-text="router.description || '無描述'"></p>
                                    
                                    {# 分析動作列表 #}
                                    <div class="text-xs text-gray-500">
                                        <span class="font-medium">分析動作:</span>
                                        <span x-text="router.actions?.length || 0"></span> 個
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="availableRouters.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>目前沒有可用的路由規則</p>
                    </div>
                </div>

                {# 錯誤訊息 #}
                <div x-show="errors.routers" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600" x-text="errors.routers"></p>
                </div>

                {# 已選擇摘要 #}
                <div x-show="selectedRouters.length > 0" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm text-green-700">
                        <i class="fas fa-check-circle mr-2"></i>
                        已選擇 <strong x-text="selectedRouters.length"></strong> 個路由規則
                    </p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-between">
                <button type="button" 
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                        @click="previousStep">
                    <i class="fas fa-arrow-left mr-2"></i>上一步
                </button>
                <button type="button" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="selectedRouters.length === 0"
                        @click="nextStep">
                    下一步 <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    {# 步驟 3: 填寫 Metadata #}
    <div x-show="currentStep === 3" class="wizard-step">
        <div class="tech-card parallax-layer parallax-layer2">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="text-lg font-semibold text-gray-900">步驟 3：填寫檔案資訊</h3>
                <p class="text-sm text-gray-600 mt-1">填寫檔案的附加資訊（選填）</p>
            </div>

            <div class="px-6 py-6">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-sm font-medium text-gray-700">編輯模式</label>
                        <div class="flex space-x-2">
                            <button type="button" 
                                    class="px-3 py-1 text-sm rounded transition"
                                    :class="jsonMode === 'form' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    @click="jsonMode = 'form'">
                                <i class="fas fa-list mr-1"></i>表單模式
                            </button>
                            <button type="button" 
                                    class="px-3 py-1 text-sm rounded transition"
                                    :class="jsonMode === 'json' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    @click="jsonMode = 'json'">
                                <i class="fas fa-code mr-1"></i>JSON 模式
                            </button>
                        </div>
                    </div>

                    {# 表單模式 #}
                    <div x-show="jsonMode === 'form'" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">資料集 UUID</label>
                            <input type="text" 
                                   x-model="infoFeatures.dataset_UUID" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如：dataset_001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">設備 ID</label>
                            <input type="text" 
                                   x-model="infoFeatures.device_id" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如：device_001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">標籤</label>
                            <select x-model="infoFeatures.label" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">請選擇</option>
                                <option value="normal">正常</option>
                                <option value="anomaly">異常</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">其他備註</label>
                            <textarea x-model="infoFeatures.notes" 
                                      rows="3"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="任何需要補充的說明..."></textarea>
                        </div>
                    </div>

                    {# JSON 模式 #}
                    <div x-show="jsonMode === 'json'">
                        <textarea x-model="jsonString" 
                                  rows="10"
                                  @blur="validateJSON"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                                  placeholder='{"dataset_UUID": "example", "device_id": "device_001"}'></textarea>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>請輸入有效的 JSON 格式
                        </p>
                    </div>
                </div>

                {# 錯誤訊息 #}
                <div x-show="errors.metadata" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600" x-text="errors.metadata"></p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-between">
                <button type="button" 
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                        @click="previousStep">
                    <i class="fas fa-arrow-left mr-2"></i>上一步
                </button>
                <button type="button" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                        @click="nextStep">
                    下一步 <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    {# 步驟 4: 確認與提交 #}
    <div x-show="currentStep === 4" class="wizard-step">
        <div class="tech-card parallax-layer parallax-layer2">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="text-lg font-semibold text-gray-900">步驟 4：確認資訊</h3>
                <p class="text-sm text-gray-600 mt-1">請確認以下資訊無誤後提交</p>
            </div>

            <div class="px-6 py-6 space-y-6">
                {# 檔案資訊 #}
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-file-audio mr-2 text-blue-600"></i>檔案資訊
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">檔案名稱:</span>
                            <span class="font-medium" x-text="selectedFile?.name"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">檔案大小:</span>
                            <span class="font-medium" x-text="formatFileSize(selectedFile?.size)"></span>
                        </div>
                    </div>
                </div>

                {# 路由規則 #}
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-route mr-2 text-green-600"></i>選擇的路由規則
                    </h4>
                    <div class="space-y-2">
                        <template x-for="routerId in selectedRouters" :key="routerId">
                            <div class="flex items-center text-sm">
                                <i class="fas fa-check-circle mr-2 text-green-600"></i>
                                <span x-text="getRouterName(routerId)"></span>
                            </div>
                        </template>
                    </div>
                    <div class="mt-3 text-sm text-gray-600">
                        執行模式: <strong x-text="sequential === 'true' ? '串行執行' : '並行執行'"></strong>
                    </div>
                </div>

                {# Metadata #}
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-tags mr-2 text-purple-600"></i>檔案資訊
                    </h4>
                    <pre class="text-xs bg-white p-3 rounded border border-gray-200 overflow-auto max-h-40" x-text="JSON.stringify(infoFeatures, null, 2)"></pre>
                </div>

                {# 成功訊息 #}
                <div x-show="uploadSuccess" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-600 text-xl mr-3 mt-1"></i>
                        <div class="flex-1">
                            <p class="font-semibold text-green-900 mb-2">上傳成功！</p>
                            <p class="text-sm text-green-700 mb-2">
                                分析 UUID: <code class="bg-white px-2 py-1 rounded" x-text="uploadResult.analyze_uuid"></code>
                            </p>
                            <p class="text-sm text-green-700 mb-3">
                                已創建 <strong x-text="uploadResult.tasks_created"></strong> 個分析任務
                            </p>
                            <a :href="'/data/' + uploadResult.analyze_uuid" 
                               class="inline-block px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition">
                                <i class="fas fa-eye mr-2"></i>查看詳情
                            </a>
                        </div>
                    </div>
                </div>

                {# 錯誤訊息 #}
                <div x-show="errors.submit" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600" x-text="errors.submit"></p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-between">
                <button type="button" 
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                        :disabled="isSubmitting"
                        @click="previousStep">
                    <i class="fas fa-arrow-left mr-2"></i>上一步
                </button>
                <div class="space-x-3">
                    <button type="button" 
                            x-show="uploadSuccess"
                            class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                            @click="resetForm">
                        <i class="fas fa-plus mr-2"></i>繼續上傳
                    </button>
                    <button type="button" 
                            x-show="!uploadSuccess"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="isSubmitting"
                            @click="submitUpload">
                        <span x-show="!isSubmitting">
                            <i class="fas fa-paper-plane mr-2"></i>提交上傳
                        </span>
                        <span x-show="isSubmitting">
                            <i class="fas fa-spinner fa-spin mr-2"></i>上傳中...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
function uploadForm() {
    return {
        currentStep: 1,
        selectedFile: null,
        isDragging: false,
        availableRouters: [],
        selectedRouters: [],
        sequential: 'true',
        infoFeatures: {},
        jsonMode: 'form',
        jsonString: '{}',
        errors: {},
        isSubmitting: false,
        uploadSuccess: false,
        uploadResult: {},
        maxFileSizeMB: 100,

        async init() {
            await this.loadRouters();
            await this.loadConfig();
        },

        async loadRouters() {
            try {
                const response = await fetch('/api/routing?enabled_only=true');
                const data = await response.json();
                if (data.success) {
                    this.availableRouters = data.data;
                }
            } catch (error) {
                console.error('載入路由規則失敗:', error);
            }
        },

        async loadConfig() {
            try {
                const response = await fetch('/api/uploads/config');
                const data = await response.json();
                if (data.success) {
                    this.maxFileSizeMB = data.config.max_file_size_mb;
                }
            } catch (error) {
                console.error('載入配置失敗:', error);
            }
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.validateAndSetFile(file);
            }
        },

        handleDrop(event) {
            this.isDragging = false;
            const file = event.dataTransfer.files[0];
            if (file) {
                this.validateAndSetFile(file);
            }
        },

        validateAndSetFile(file) {
            this.errors.file = '';

            // 檢查檔案大小
            const maxSize = this.maxFileSizeMB * 1024 * 1024;
            if (file.size > maxSize) {
                this.errors.file = `檔案大小超過限制 (${this.maxFileSizeMB} MB)`;
                return;
            }

            // 檢查檔案格式
            const allowedExtensions = ['.wav', '.mp3', '.m4a', '.flac', '.ogg', '.aac'];
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(extension)) {
                this.errors.file = `不支援的檔案格式。允許: ${allowedExtensions.join(', ')}`;
                return;
            }

            this.selectedFile = file;
        },

        clearFile() {
            this.selectedFile = null;
            document.getElementById('fileInput').value = '';
        },

        toggleRouter(routerId) {
            const index = this.selectedRouters.indexOf(routerId);
            if (index > -1) {
                this.selectedRouters.splice(index, 1);
            } else {
                this.selectedRouters.push(routerId);
            }
        },

        getRouterName(routerId) {
            const router = this.availableRouters.find(r => r.rule_id === routerId);
            return router ? router.rule_name : routerId;
        },

        validateJSON() {
            try {
                this.infoFeatures = JSON.parse(this.jsonString);
                this.errors.metadata = '';
            } catch (error) {
                this.errors.metadata = 'JSON 格式錯誤: ' + error.message;
            }
        },

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        nextStep() {
            this.errors = {};

            // 驗證當前步驟
            if (this.currentStep === 1 && !this.selectedFile) {
                this.errors.file = '請選擇檔案';
                return;
            }
            if (this.currentStep === 2 && this.selectedRouters.length === 0) {
                this.errors.routers = '請至少選擇一個路由規則';
                return;
            }
            if (this.currentStep === 3 && this.jsonMode === 'json') {
                this.validateJSON();
                if (this.errors.metadata) return;
            }

            // 同步表單模式與 JSON 模式
            if (this.currentStep === 3) {
                this.jsonString = JSON.stringify(this.infoFeatures, null, 2);
            }

            this.currentStep++;
        },

        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
            }
        },

        async submitUpload() {
            this.isSubmitting = true;
            this.errors.submit = '';

            try {
                const formData = new FormData();
                formData.append('file', this.selectedFile);
                this.selectedRouters.forEach(id => formData.append('router_ids', id));
                formData.append('info_features', JSON.stringify(this.infoFeatures));
                formData.append('sequential', this.sequential);

                const response = await fetch('/api/uploads/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    this.uploadSuccess = true;
                    this.uploadResult = data;
                } else {
                    this.errors.submit = data.error || '上傳失敗';
                }
            } catch (error) {
                this.errors.submit = '上傳失敗: ' + error.message;
            } finally {
                this.isSubmitting = false;
            }
        },

        resetForm() {
            this.currentStep = 1;
            this.selectedFile = null;
            this.selectedRouters = [];
            this.sequential = 'true';
            this.infoFeatures = {};
            this.jsonString = '{}';
            this.jsonMode = 'form';
            this.errors = {};
            this.uploadSuccess = false;
            this.uploadResult = {};
            document.getElementById('fileInput').value = '';
        }
    };
}
</script>
{% endblock %}
