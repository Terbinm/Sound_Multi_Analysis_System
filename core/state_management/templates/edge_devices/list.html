{% extends "base.html" %}

{% block title %}Edge 設備管理{% endblock %}
{% block page_title %}Edge 設備管理{% endblock %}

{% block content %}
<!-- 頁面說明 -->
<div class="mb-8">
    <div class="tech-card-sm p-6 bg-gradient-to-r from-emerald-50 to-teal-50 border-l-4 border-emerald-500">
        <div class="flex items-start gap-4">
            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg flex-shrink-0">
                <i class="fas fa-satellite-dish text-white text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-2">Edge 設備控制</h2>
                <p class="text-sm text-gray-600">
                    管理 Edge 錄音設備、遠端觸發錄音，以及設定排程錄音任務。設備首次連線時會自動註冊。
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 統計卡片 -->
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-12 tech-grid">
    <!-- 總設備數 -->
    <div class="tech-card-sm overflow-hidden group">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 p-3 shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-satellite-dish text-white text-2xl tech-icon-float"></i>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-gray-900 tech-counter" id="stat-total">{{ stats.total_devices }}</div>
                    <div class="text-sm text-gray-500 mt-1">台設備</div>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">總設備數</h3>
            </div>
        </div>
        <div class="h-1 bg-gradient-to-r from-emerald-500 to-teal-600"></div>
    </div>

    <!-- 在線設備 -->
    <div class="tech-card-sm overflow-hidden group">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 p-3 shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-check-circle text-white text-2xl tech-icon-float"></i>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-green-600 tech-counter" id="stat-online">{{ stats.online_devices }}</div>
                    <div class="text-sm text-gray-500 mt-1">在線</div>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">在線設備</h3>
            </div>
        </div>
        <div class="h-1 bg-gradient-to-r from-green-500 to-emerald-600"></div>
    </div>

    <!-- 錄音中 -->
    <div class="tech-card-sm overflow-hidden group">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="rounded-xl bg-gradient-to-br from-red-500 to-rose-600 p-3 shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-circle text-white text-2xl tech-icon-float animate-pulse"></i>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-red-600 tech-counter" id="stat-recording">{{ stats.recording_devices }}</div>
                    <div class="text-sm text-gray-500 mt-1">錄音中</div>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">錄音中</h3>
            </div>
        </div>
        <div class="h-1 bg-gradient-to-r from-red-500 to-rose-600"></div>
    </div>

    <!-- 離線設備 -->
    <div class="tech-card-sm overflow-hidden group">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="rounded-xl bg-gradient-to-br from-gray-400 to-gray-500 p-3 shadow-lg group-hover:shadow-xl transition-all duration-300">
                    <i class="fas fa-power-off text-white text-2xl tech-icon-float"></i>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-gray-500 tech-counter" id="stat-offline">{{ stats.offline_devices }}</div>
                    <div class="text-sm text-gray-500 mt-1">離線</div>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">離線設備</h3>
            </div>
        </div>
        <div class="h-1 bg-gradient-to-r from-gray-400 to-gray-500"></div>
    </div>
</div>

<!-- 設備列表 - 大卡片佈局 -->
<div>
    {% if devices %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="devices-grid">
        {% for device in devices %}
        <div class="tech-card h-full overflow-hidden group hover:shadow-xl transition-all duration-300"
             data-device-id="{{ device.device_id }}"
             data-status="{{ device.status }}">

            <!-- 主要內容區 - 上半部分：照片 + 基本資訊 -->
            <div class="p-6">
                <div class="flex gap-5">
                    <!-- 左側：設備照片區塊 -->
                    <div class="flex-shrink-0">
                        <div class="relative">
                            {% if device.photo_path %}
                            <div class="h-36 w-36 rounded-xl overflow-hidden shadow-md">
                                <img src="{{ url_for('edge_device_api.get_device_photo', device_id=device.device_id) }}"
                                     alt="設備照片"
                                     class="h-full w-full object-cover device-photo"
                                     onerror="this.parentElement.innerHTML='<div class=\'h-full w-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center\'><i class=\'fas fa-satellite-dish text-white text-3xl\'></i></div>'">
                            </div>
                            {% else %}
                            <!-- 預設圖標佔位 -->
                            <div class="h-36 w-36 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-md">
                                <i class="fas fa-satellite-dish text-white text-3xl"></i>
                            </div>
                            {% endif %}
                            <!-- 狀態指示燈 -->
                            <span class="status-indicator absolute -top-1 -right-1 h-5 w-5 rounded-full border-2 border-white shadow-sm
                                {% if device.status == 'IDLE' %}bg-green-500
                                {% elif device.status == 'RECORDING' %}bg-red-500 animate-pulse
                                {% else %}bg-gray-400{% endif %}">
                            </span>
                        </div>
                    </div>

                    <!-- 右側：設備資訊區塊 -->
                    <div class="flex-1 min-w-0">
                        <!-- 設備名稱 + 狀態 -->
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 truncate group-hover:text-emerald-600 transition-colors device-name">
                                    {{ device.device_name or device.device_id[:12] }}
                                </h3>
                                <p class="text-xs text-gray-500 font-mono truncate">
                                    {{ device.device_id[:20] }}...
                                </p>
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                <span class="tech-badge text-xs status-badge
                                    {% if device.status == 'IDLE' %}bg-green-100 text-green-700 border-green-200
                                    {% elif device.status == 'RECORDING' %}bg-red-100 text-red-700 border-red-200
                                    {% else %}bg-gray-100 text-gray-600 border-gray-200{% endif %}">
                                    {% if device.status == 'IDLE' %}在線
                                    {% elif device.status == 'RECORDING' %}錄音中
                                    {% else %}離線{% endif %}
                                </span>
                                {% if device.status == 'OFFLINE' and device.offline_reason %}
                                <span class="offline-reason text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    {% if device.offline_reason == 'never_connected' %}從未連線
                                    {% elif device.offline_reason == 'heartbeat_timeout' %}心跳超時
                                    {% elif device.offline_reason == 'connection_lost' %}連線中斷
                                    {% else %}未知原因{% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 位置資訊（標籤式） -->
                        {% set location = device.location or {} %}
                        <div class="mb-3">
                            <div class="flex flex-wrap gap-1.5 location-tags">
                                {% if location.name or location.building or location.floor or location.room %}
                                    {% if location.name %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-700 border border-emerald-200">
                                        <i class="fas fa-location-dot mr-1 text-[10px]"></i>{{ location.name }}
                                    </span>
                                    {% endif %}
                                    {% if location.building %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 border border-gray-200">
                                        <i class="fas fa-building mr-1 text-[10px]"></i>{{ location.building }}
                                    </span>
                                    {% endif %}
                                    {% if location.floor %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 border border-gray-200">
                                        {{ location.floor }}F
                                    </span>
                                    {% endif %}
                                    {% if location.room %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 border border-gray-200">
                                        <i class="fas fa-door-open mr-1 text-[10px]"></i>{{ location.room }}
                                    </span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-xs text-gray-400">未設定位置</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 管理人員頭像堆疊 -->
                        <div class="managers-container" data-device-id="{{ device.device_id }}" data-manager-ids="{{ device.manager_ids | tojson if device.manager_ids else '[]' }}">
                            {% if device.manager_ids %}
                            <div class="flex items-center">
                                <div class="managers-avatar-stack flex -space-x-2">
                                    <!-- JavaScript 動態載入頭像 -->
                                </div>
                                <span class="managers-count ml-2 text-xs text-gray-500"></span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">
                                <i class="fas fa-user-slash mr-1"></i>未指派管理人員
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 統計數據區塊 -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <div class="grid grid-cols-4 gap-3">
                        <div class="text-center p-2 rounded-lg bg-gray-50">
                            <div class="text-[10px] text-gray-500 mb-0.5">平台</div>
                            <div class="text-sm font-semibold text-gray-900">{{ device.platform or '未知' }}</div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-gray-50">
                            <div class="text-[10px] text-gray-500 mb-0.5">總錄音</div>
                            <div class="text-sm font-semibold text-gray-900 recording-total">
                                {{ device.statistics.total_recordings if device.statistics else 0 }}
                            </div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-green-50">
                            <div class="text-[10px] text-gray-500 mb-0.5">已分析</div>
                            <div class="text-sm font-semibold text-green-600 recording-analyzed">
                                {{ device.statistics.success_count if device.statistics else 0 }}
                            </div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-red-50">
                            <div class="text-[10px] text-gray-500 mb-0.5">失敗</div>
                            <div class="text-sm font-semibold text-red-600 recording-failed">
                                {{ device.statistics.error_count if device.statistics else 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 底部操作區 -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <!-- 排程狀態 -->
                        {% set schedule = device.schedule_config or {} %}
                        <div class="flex items-center gap-2 text-xs">
                            <i class="fas fa-clock {% if schedule.enabled %}text-emerald-600{% else %}text-gray-400{% endif %}"></i>
                            <span class="{% if schedule.enabled %}text-emerald-700{% else %}text-gray-500{% endif %} truncate">
                                {% if schedule.enabled %}
                                    每 {{ schedule.interval_seconds // 60 }} 分，錄 {{ schedule.duration_seconds }} 秒
                                {% else %}
                                    排程停用
                                {% endif %}
                            </span>
                        </div>
                        <!-- 最後上線時間 -->
                        <div class="text-[10px] text-gray-400 mt-1 truncate last-heartbeat">
                            {% if device.connection_info and device.connection_info.last_heartbeat %}
                                最後上線: {{ device.connection_info.last_heartbeat | to_taipei_tz }}
                            {% else %}
                                從未連線
                            {% endif %}
                        </div>
                    </div>
                    <a href="{{ url_for('views.edge_device_detail', device_id=device.device_id) }}"
                       class="flex-shrink-0 inline-flex items-center gap-1.5 px-4 py-2 rounded-lg bg-white border border-gray-200 text-sm font-medium text-gray-700 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-300 transition-all duration-200 shadow-sm">
                        詳情
                        <i class="fas fa-arrow-right text-xs group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="tech-card overflow-hidden">
        <div class="px-6 py-16">
            <div class="tech-empty-state">
                <div class="tech-empty-state-icon mx-auto mb-4">
                    <i class="fas fa-satellite-dish text-6xl text-gray-300"></i>
                </div>
                <p class="text-lg font-medium text-gray-600">尚無 Edge 設備</p>
                <p class="text-sm text-gray-500 mt-2">設備連線並向伺服器註冊後，將會顯示在此處</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if error %}
<div class="mt-8">
    <div class="tech-card border-l-4 border-red-500 bg-red-50">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="h-10 w-10 rounded-lg bg-red-100 flex items-center justify-center">
                        <i class="fas fa-exclamation-circle text-red-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-semibold text-red-800 mb-1">載入資料時發生錯誤</h3>
                    <p class="text-sm text-red-700">{{ error }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// WebSocket 連線
const socket = io();

// 訂閱房間
function subscribeToEdgeDevices() {
    socket.emit('subscribe', {room: 'edge_devices'});
    console.log('[EdgeDevices] 已訂閱 edge_devices 房間');
}

if (socket.connected) {
    subscribeToEdgeDevices();
}

socket.on('connect', function() {
    console.log('[EdgeDevices] Socket 已連接');
    subscribeToEdgeDevices();
});

// ===== 管理人員頭像載入 =====
async function loadManagerAvatars() {
    const containers = document.querySelectorAll('.managers-container[data-manager-ids]');

    for (const container of containers) {
        const deviceId = container.dataset.deviceId;
        const managerIds = JSON.parse(container.dataset.managerIds || '[]');

        if (!managerIds.length) continue;

        try {
            const response = await fetch(`/api/edge-devices/${deviceId}/managers`, {
                credentials: 'same-origin'
            });
            if (!response.ok) {
                console.warn(`設備 ${deviceId} 管理人員 API 回應錯誤: ${response.status}`);
                continue;
            }
            const data = await response.json();

            if (data.success && data.managers && data.managers.length > 0) {
                renderManagerAvatars(container, data.managers);
            }
        } catch (error) {
            console.error(`載入設備 ${deviceId} 管理人員失敗:`, error);
        }
    }
}

function renderManagerAvatars(container, managers) {
    const stackEl = container.querySelector('.managers-avatar-stack');
    const countEl = container.querySelector('.managers-count');

    if (!stackEl) return;

    stackEl.innerHTML = '';

    // 最多顯示 3 個頭像
    const displayCount = Math.min(managers.length, 3);
    const colors = ['bg-blue-500', 'bg-purple-500', 'bg-amber-500', 'bg-rose-500'];

    for (let i = 0; i < displayCount; i++) {
        const manager = managers[i];
        const initial = (manager.username || '?')[0].toUpperCase();
        const colorClass = colors[i % colors.length];

        const avatar = document.createElement('div');
        avatar.className = `h-7 w-7 rounded-full ${colorClass} flex items-center justify-center text-white text-xs font-medium border-2 border-white shadow-sm`;
        avatar.title = manager.username;
        avatar.textContent = initial;
        stackEl.appendChild(avatar);
    }

    // 顯示剩餘數量
    if (managers.length > 3) {
        const more = document.createElement('div');
        more.className = 'h-7 w-7 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs font-medium border-2 border-white shadow-sm';
        more.textContent = `+${managers.length - 3}`;
        stackEl.appendChild(more);
    }

    // 更新計數文字
    if (countEl) {
        countEl.textContent = `${managers.length} 位管理人員`;
    }
}

// 頁面載入時執行
document.addEventListener('DOMContentLoaded', loadManagerAvatars);

// ===== WebSocket 事件處理 =====

// 設備狀態變更
socket.on('edge_device.status_changed', function(data) {
    updateDeviceStatus(data.device_id, data.status);
});

// 設備上線
socket.on('edge_device.online', function(data) {
    location.reload();
});

// 設備離線
socket.on('edge_device.offline', function(data) {
    updateDeviceStatus(data.device_id, 'OFFLINE', data.offline_reason, data.offline_reason_display);
});

// 統計更新
socket.on('edge_device.stats_updated', function(data) {
    document.getElementById('stat-total').textContent = data.total_devices || 0;
    document.getElementById('stat-online').textContent = data.online_devices || 0;
    document.getElementById('stat-recording').textContent = data.recording_devices || 0;
    document.getElementById('stat-offline').textContent = data.offline_devices || 0;
});

// 新設備註冊
socket.on('edge_device.registered', function(data) {
    location.reload();
});

// 管理人員更新
socket.on('edge_device.managers_updated', function(data) {
    const container = document.querySelector(`.managers-container[data-device-id="${data.device_id}"]`);
    if (container) {
        container.dataset.managerIds = JSON.stringify(data.manager_ids || []);
        loadManagerAvatars();
    }
});

// 照片更新
socket.on('edge_device.photo_updated', function(data) {
    const card = document.querySelector(`[data-device-id="${data.device_id}"]`);
    if (card) {
        const photoImg = card.querySelector('.device-photo');
        if (photoImg) {
            // 強制重新載入照片
            photoImg.src = photoImg.src.split('?')[0] + '?t=' + Date.now();
        } else {
            // 如果原本沒有照片，重新載入頁面
            location.reload();
        }
    }
});

// 位置更新
socket.on('edge_device.location_updated', function(data) {
    // 位置更新時重新載入頁面以顯示新的位置標籤
    location.reload();
});

// 離線原因對照表
const offlineReasonDisplay = {
    'never_connected': '從未連線',
    'heartbeat_timeout': '心跳超時',
    'connection_lost': '連線中斷'
};

// 更新設備狀態
function updateDeviceStatus(deviceId, status, offlineReason, offlineReasonText) {
    const card = document.querySelector(`[data-device-id="${deviceId}"]`);
    if (!card) return;

    card.setAttribute('data-status', status);

    // 判斷狀態
    const isOnline = (status === 'IDLE');
    const isRecording = (status === 'RECORDING');

    // 更新狀態指示燈
    const indicator = card.querySelector('.status-indicator');
    if (indicator) {
        indicator.className = 'status-indicator absolute -top-1 -right-1 h-5 w-5 rounded-full border-2 border-white shadow-sm';
        if (isOnline) {
            indicator.classList.add('bg-green-500');
        } else if (isRecording) {
            indicator.classList.add('bg-red-500', 'animate-pulse');
        } else {
            indicator.classList.add('bg-gray-400');
        }
    }

    // 更新狀態標籤
    const badge = card.querySelector('.status-badge');
    if (badge) {
        badge.className = 'tech-badge text-xs status-badge';
        if (isOnline) {
            badge.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
            badge.textContent = '在線';
        } else if (isRecording) {
            badge.classList.add('bg-red-100', 'text-red-700', 'border-red-200');
            badge.textContent = '錄音中';
        } else {
            badge.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
            badge.textContent = '離線';
        }
    }

    // 更新離線原因
    let reasonSpan = card.querySelector('.offline-reason');
    if (status === 'OFFLINE' && offlineReason) {
        const reasonText = offlineReasonText || offlineReasonDisplay[offlineReason] || '未知原因';
        if (!reasonSpan) {
            reasonSpan = document.createElement('span');
            reasonSpan.className = 'offline-reason text-xs text-gray-500';
            const badgeContainer = badge.parentElement;
            if (badgeContainer) {
                badgeContainer.appendChild(reasonSpan);
            }
        }
        reasonSpan.innerHTML = `<i class="fas fa-info-circle mr-1"></i>${reasonText}`;
        reasonSpan.style.display = '';
    } else if (reasonSpan) {
        reasonSpan.style.display = 'none';
    }
}
</script>
{% endblock %}
