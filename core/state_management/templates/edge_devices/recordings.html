{% extends "base.html" %}

{% block title %}{{ device.device_name or 'Edge 設備' }} - 錄音歷史{% endblock %}
{% block page_title %}錄音歷史{% endblock %}

{% block content %}
<!-- 返回連結 -->
<div class="mb-6 flex items-center justify-between">
    <a href="{{ url_for('views.edge_device_detail', device_id=device.device_id) }}"
       class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-emerald-600 transition-colors">
        <i class="fas fa-arrow-left"></i>
        返回設備詳情
    </a>
    <div class="flex items-center gap-2">
        <span class="text-sm text-gray-500">設備:</span>
        <span class="font-semibold text-gray-900">{{ device.device_name or device.device_id[:12] }}</span>
    </div>
</div>

<!-- 錄音列表 -->
<div class="tech-card overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">
            錄音記錄
            <span class="text-sm font-normal text-gray-500 ml-2">(共 {{ pagination.total }} 筆)</span>
        </h3>
    </div>

    {% if recordings %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分析 UUID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">檔案名稱</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時長</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">檔案大小</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">指定路由</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">建立時間</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for recording in recordings %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{{ url_for('views.data_detail', analyze_uuid=recording.analyze_uuid) }}"
                           class="text-sm font-mono text-emerald-600 hover:text-emerald-700 hover:underline"
                           title="{{ recording.analyze_uuid }}">
                            {{ recording.analyze_uuid[:20] if recording.analyze_uuid else '-' }}...
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 truncate max-w-xs" title="{{ recording.filename }}">
                            {{ recording.filename or '-' }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-600">
                            {% if recording.duration %}
                                {{ recording.duration|round(1) }} 秒
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-600">
                            {% if recording.file_size %}
                                {{ (recording.file_size / 1024)|round(1) }} KB
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if recording.assigned_router_ids %}
                            <div class="flex flex-wrap gap-1">
                                {% for router_id in recording.assigned_router_ids[:3] %}
                                    <span class="tech-badge text-xs bg-blue-100 text-blue-700 border-blue-200">
                                        {{ router_id[:8] }}...
                                    </span>
                                {% endfor %}
                                {% if recording.assigned_router_ids|length > 3 %}
                                    <span class="text-xs text-gray-500">+{{ recording.assigned_router_ids|length - 3 }}</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if recording.created_at %}
                            {{ recording.created_at | to_taipei_tz('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            <a href="{{ url_for('data_api.download_audio', analyze_uuid=recording.analyze_uuid) }}"
                               class="text-blue-600 hover:text-blue-800 transition-colors" title="下載音訊">
                                <i class="fas fa-download"></i>
                            </a>
                            <button onclick="confirmDelete('{{ recording.analyze_uuid }}', '{{ recording.filename or recording.analyze_uuid[:16] }}')"
                                    class="text-red-600 hover:text-red-800 transition-colors" title="刪除記錄">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分頁 -->
    {% if pagination.pages > 1 %}
    <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
        <div class="text-sm text-gray-500">
            顯示第 {{ ((pagination.page - 1) * pagination.page_size) + 1 }} -
            {{ [pagination.page * pagination.page_size, pagination.total]|min }} 筆，共 {{ pagination.total }} 筆
        </div>
        <div class="flex items-center gap-2">
            {% if pagination.page > 1 %}
            <a href="{{ url_for('views.edge_device_recordings', device_id=device.device_id, page=pagination.page-1) }}"
               class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                <i class="fas fa-chevron-left"></i> 上一頁
            </a>
            {% endif %}

            {% for p in range(1, pagination.pages + 1) %}
                {% if p == pagination.page %}
                    <span class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-sm">{{ p }}</span>
                {% elif p == 1 or p == pagination.pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                    <a href="{{ url_for('views.edge_device_recordings', device_id=device.device_id, page=p) }}"
                       class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                        {{ p }}
                    </a>
                {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                    <span class="px-2 text-gray-400">...</span>
                {% endif %}
            {% endfor %}

            {% if pagination.page < pagination.pages %}
            <a href="{{ url_for('views.edge_device_recordings', device_id=device.device_id, page=pagination.page+1) }}"
               class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                下一頁 <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="px-6 py-16 text-center">
        <div class="tech-empty-state">
            <div class="tech-empty-state-icon mx-auto mb-4">
                <i class="fas fa-file-audio text-6xl text-gray-300"></i>
            </div>
            <p class="text-lg font-medium text-gray-600">找不到錄音記錄</p>
            <p class="text-sm text-gray-500 mt-2">此設備尚未上傳任何錄音。</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- 刪除確認彈窗 -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>確認刪除
        </h3>
        <p class="text-gray-600 mb-2">確定要刪除此錄音嗎？</p>
        <p class="text-sm text-gray-500 mb-4 font-mono" id="deleteFileName"></p>
        <p class="text-sm text-red-600 mb-6">此操作無法復原，所有相關檔案和任務日誌都將被永久刪除。</p>
        <div class="flex justify-end gap-4">
            <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                取消
            </button>
            <button onclick="executeDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-trash mr-2"></i>刪除
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let deleteTargetUUID = null;

    function confirmDelete(analyzeUUID, filename) {
        deleteTargetUUID = analyzeUUID;
        document.getElementById('deleteFileName').textContent = filename;
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
        deleteTargetUUID = null;
    }

    async function executeDelete() {
        if (!deleteTargetUUID) return;

        try {
            const response = await fetch(`/api/data/${deleteTargetUUID}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                // 刪除成功，重新載入頁面
                window.location.reload();
            } else {
                alert('刪除失敗：' + (result.error || '未知錯誤'));
            }
        } catch (error) {
            console.error('刪除錯誤:', error);
            alert('刪除錄音時發生錯誤：' + error.message);
        }

        closeDeleteModal();
    }

    // 點擊彈窗外部關閉
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    // ESC 鍵關閉彈窗
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}
