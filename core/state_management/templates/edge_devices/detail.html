{% extends "base.html" %}

{% block title %}{{ device.device_name or 'Edge 設備' }} - 詳情{% endblock %}
{% block page_title %}Edge 設備詳情{% endblock %}

{% block content %}
<!-- 返回連結 -->
<div class="mb-6">
    <a href="{{ url_for('views.edge_devices_list') }}" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-emerald-600 transition-colors">
        <i class="fas fa-arrow-left"></i>
        返回設備列表
    </a>
</div>

<!-- 設備資訊卡片 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- 主要資訊 -->
    <div class="lg:col-span-2 tech-card overflow-hidden">
        <div class="p-6">
            <!-- 主要內容區域 - 左右分欄佈局 -->
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左側：設備照片區塊 -->
                <div class="flex-shrink-0">
                    <div class="relative group">
                        {% if device.photo_path %}
                        <div class="h-40 w-40 lg:h-48 lg:w-48 rounded-2xl overflow-hidden shadow-lg relative">
                            <img id="device-photo" src="{{ url_for('edge_device_api.get_device_photo', device_id=device.device_id) }}"
                                 alt="設備照片" class="h-full w-full object-cover">
                            <span id="status-indicator" class="absolute -top-1 -right-1 h-6 w-6 rounded-full border-2 border-white shadow-sm
                                {% if device.status == 'IDLE' %}bg-green-500{% elif device.status == 'RECORDING' %}bg-red-500 animate-pulse{% else %}bg-gray-400{% endif %}">
                            </span>
                        </div>
                        {% else %}
                        <div class="h-40 w-40 lg:h-48 lg:w-48 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg relative">
                            <i class="fas fa-satellite-dish text-white text-4xl lg:text-5xl"></i>
                            <span id="status-indicator" class="absolute -top-1 -right-1 h-6 w-6 rounded-full border-2 border-white shadow-sm
                                {% if device.status == 'IDLE' %}bg-green-500{% elif device.status == 'RECORDING' %}bg-red-500 animate-pulse{% else %}bg-gray-400{% endif %}">
                            </span>
                        </div>
                        {% endif %}
                        <!-- 照片上傳按鈕 (hover 時顯示) -->
                        <button onclick="deviceDetail.openUnifiedConfigModal({{ (device.schedule_config or {}).interval_seconds or 3600 }})"
                                class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                            <div class="text-center">
                                <i class="fas fa-edit text-white text-2xl mb-1"></i>
                                <p class="text-white text-xs">編輯資訊</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- 右側：設備資訊區塊 -->
                <div class="flex-1 min-w-0">
                    <!-- 設備名稱 + 狀態 + 編輯按鈕 -->
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" id="device-name-display">{{ device.device_name or '未命名設備' }}</h2>
                            <p class="text-sm text-gray-500 font-mono mt-1">{{ device.device_id }}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="deviceDetail.openUnifiedConfigModal({{ (device.schedule_config or {}).interval_seconds or 3600 }})"
                                    class="px-3 py-2 text-sm bg-blue-50 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <div class="flex flex-col items-end gap-1">
                                <span id="status-badge" class="tech-badge text-sm px-4 py-2 {% if device.status == 'IDLE' %}bg-green-100 text-green-700 border-green-200{% elif device.status == 'RECORDING' %}bg-red-100 text-red-700 border-red-200{% else %}bg-gray-100 text-gray-600 border-gray-200{% endif %}">{% if device.status == 'IDLE' %}在線{% elif device.status == 'RECORDING' %}錄音中{% else %}離線{% endif %}</span>
                                {% if device.status == 'OFFLINE' and device.offline_reason %}
                                <span id="offline-reason" class="text-xs text-gray-500" title="離線原因">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    {% if device.offline_reason == 'never_connected' %}從未連線
                                    {% elif device.offline_reason == 'heartbeat_timeout' %}心跳超時
                                    {% elif device.offline_reason == 'connection_lost' %}連線中斷
                                    {% else %}未知原因{% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- 位置資訊 (標籤式) -->
                    {% set location = device.location or {} %}
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-map-marker-alt text-emerald-500"></i>
                            <span class="text-sm font-medium text-gray-700">位置資訊</span>
                            <button onclick="deviceDetail.openUnifiedConfigModal({{ (device.schedule_config or {}).interval_seconds or 3600 }})" class="text-xs text-gray-400 hover:text-emerald-500 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div id="location-tags-container" class="flex flex-wrap gap-2">
                            {% if location.name or location.building or location.floor or location.room %}
                                {% if location.name %}
                                <span id="location-name-tag" class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-emerald-100 text-emerald-700 border border-emerald-200">
                                    <i class="fas fa-location-dot mr-1.5 text-xs"></i>{{ location.name }}
                                </span>
                                {% endif %}
                                {% if location.building %}
                                <span id="location-building-tag" class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700 border border-gray-200">
                                    <i class="fas fa-building mr-1.5 text-xs"></i>{{ location.building }}
                                </span>
                                {% endif %}
                                {% if location.floor %}
                                <span id="location-floor-tag" class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700 border border-gray-200">
                                    <i class="fas fa-layer-group mr-1.5 text-xs"></i>{{ location.floor }}
                                </span>
                                {% endif %}
                                {% if location.room %}
                                <span id="location-room-tag" class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700 border border-gray-200">
                                    <i class="fas fa-door-open mr-1.5 text-xs"></i>{{ location.room }}
                                </span>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-400">尚未設定位置</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 管理人員 (頭像堆疊) -->
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-users text-blue-500"></i>
                            <span class="text-sm font-medium text-gray-700">管理人員</span>
                            <button onclick="deviceDetail.openUnifiedConfigModal({{ (device.schedule_config or {}).interval_seconds or 3600 }})" class="text-xs text-gray-400 hover:text-blue-500 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div id="managers-avatar-container">
                            {% set manager_ids = device.manager_ids or [] %}
                            {% if manager_ids %}
                            <div class="flex items-center">
                                <div id="managers-avatar-stack" class="flex -space-x-2">
                                    <!-- 頭像會透過 JavaScript 載入 -->
                                </div>
                                <span id="managers-count-badge" class="ml-2 text-sm text-gray-500"></span>
                            </div>
                            {% else %}
                            <span class="text-sm text-gray-400">尚未指派管理人員</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 統計資訊列 - 放在底部 -->
            <div class="mt-6 pt-6 border-t border-gray-100">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-4 rounded-lg bg-gray-50">
                        <div class="text-xs text-gray-500 mb-1">平台</div>
                        <div class="font-semibold text-gray-900">{{ device.platform or '未知' }}</div>
                    </div>
                    <div class="p-4 rounded-lg bg-gray-50">
                        <div class="text-xs text-gray-500 mb-1">總錄音數</div>
                        <div class="font-semibold text-gray-900">{{ device_stats.total_recordings or 0 }}</div>
                    </div>
                    <div class="p-4 rounded-lg bg-gray-50">
                        <div class="text-xs text-gray-500 mb-1">已分析</div>
                        <div class="font-semibold text-green-600">{{ device_stats.success_count or 0 }}</div>
                    </div>
                    <div class="p-4 rounded-lg bg-gray-50">
                        <div class="text-xs text-gray-500 mb-1">失敗</div>
                        <div class="font-semibold text-red-600">{{ device_stats.error_count or 0 }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 -->
    <div class="tech-card overflow-hidden">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">快速操作</h3>

            <!-- 即時錄音 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">錄音時長（秒）</label>
                <div class="flex gap-2">
                    <input type="number" id="record-duration" value="60" min="1" max="3600"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <button onclick="deviceDetail.triggerRecording()" id="record-btn"
                            class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            {% if device.status != 'IDLE' %}disabled{% endif %}>
                        <i class="fas fa-circle mr-1"></i> 錄音
                    </button>
                </div>
                {% if device.status != 'IDLE' %}
                <p class="text-xs text-gray-500 mt-2">設備必須在線才能錄音</p>
                {% endif %}

                <!-- 錄音進度條（預設隱藏） -->
                <div id="recording-progress-container" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-red-600">
                            <i class="fas fa-circle animate-pulse mr-1"></i>錄音中
                        </span>
                        <span id="recording-progress-text" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="recording-progress-bar" class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 查詢音訊設備 -->
            <button onclick="deviceDetail.queryAudioDevices()"
                    class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors mb-3 disabled:opacity-50"
                    {% if device.status != 'IDLE' %}disabled{% endif %}>
                <i class="fas fa-search mr-1"></i> 查詢音訊設備
            </button>

            <!-- 查看錄音歷史 -->
            <a href="{{ url_for('views.edge_device_recordings', device_id=device.device_id) }}"
               class="block w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors text-center mb-3">
                <i class="fas fa-history mr-1"></i> 錄音歷史
            </a>

            <!-- 刪除設備（僅離線設備可刪除） -->
            <button onclick="deviceDetail.deleteDevice()" id="delete-btn"
                    class="w-full px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg font-medium hover:bg-red-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-red-50"
                    {% if device.status != 'OFFLINE' %}disabled{% endif %}>
                <i class="fas fa-trash-alt mr-1"></i> 刪除設備
            </button>
            {% if device.status != 'OFFLINE' %}
            <p class="text-xs text-gray-500 mt-2">僅可刪除離線設備</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- 設備配置區塊 -->
<div class="tech-card overflow-hidden mb-8">
    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors"
         onclick="deviceDetail.toggleConfigSection(event)">
        <div class="flex items-center gap-3">
            <i id="config-collapse-icon" class="fas fa-chevron-right text-gray-400 transition-transform duration-200"></i>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-sliders-h mr-2 text-emerald-500"></i>設備配置
                </h3>
                <p class="text-sm text-gray-500 mt-1">音訊參數、排程錄音與自動分析路由設定</p>
            </div>
        </div>
        <button onclick="event.stopPropagation(); deviceDetail.openUnifiedConfigModal({{ (device.schedule_config or {}).interval_seconds or 3600 }})"
                class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition-colors disabled:opacity-50"
                {% if device.status != 'IDLE' %}disabled{% endif %}>
            <i class="fas fa-edit mr-1"></i> 編輯所有設定
        </button>
    </div>
    <div id="config-section-content" class="p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 音訊配置 -->
            <div class="space-y-4">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-gray-800">
                        <i class="fas fa-microphone mr-2 text-orange-500"></i>音訊配置
                    </h4>
                </div>

                {% set audio = device.audio_config or {} %}
                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">設備索引</span>
                        <span class="font-medium text-sm text-gray-900">{{ audio.default_device_index or 0 }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">取樣率</span>
                        <span class="font-medium text-sm text-gray-900">{{ audio.sample_rate or 16000 }} Hz</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">聲道數</span>
                        <span class="font-medium text-sm text-gray-900">{{ audio.channels or 1 }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">位元深度</span>
                        <span class="font-medium text-sm text-gray-900">{{ audio.bit_depth or 16 }} bit</span>
                    </div>
                </div>

                <!-- 可用音訊設備 -->
                {% if audio.available_devices %}
                <div class="mt-4">
                    <h5 class="text-xs font-semibold text-gray-600 mb-2">可用音訊設備</h5>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        {% for dev in audio.available_devices %}
                        <div class="p-2 rounded bg-gray-50 text-xs">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-800 truncate" title="{{ dev.name }}">{{ dev.name }}</span>
                                <span class="text-gray-500 ml-2 flex-shrink-0">#{{ dev.index }}</span>
                            </div>
                            <div class="text-gray-500 mt-0.5">
                                {{ dev.max_input_channels }}ch | {{ dev.default_sample_rate }}Hz
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- 排程配置 -->
            <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-gray-800">
                        <i class="fas fa-clock mr-2 text-blue-500"></i>排程配置
                    </h4>
                    {% set schedule = device.schedule_config or {} %}
                    <span class="tech-badge text-xs {% if schedule.enabled %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-600{% endif %}">
                        {% if schedule.enabled %}已啟用{% else %}已停用{% endif %}
                    </span>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">狀態</span>
                        <span class="font-medium text-sm {% if schedule.enabled %}text-green-600{% else %}text-gray-500{% endif %}">
                            {% if schedule.enabled %}啟用中{% else %}未啟用{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">間隔時間</span>
                        <span class="font-medium text-sm text-gray-900">
                            {% set interval = schedule.interval_seconds or 3600 %}
                            {% set days = (interval // 86400)|int %}
                            {% set hours = ((interval % 86400) // 3600)|int %}
                            {% set minutes = ((interval % 3600) // 60)|int %}
                            {% set seconds = interval % 60 %}
                            {% set parts = [] %}
                            {% if days > 0 %}{% set _ = parts.append(days ~ ' 天') %}{% endif %}
                            {% if hours > 0 %}{% set _ = parts.append(hours ~ ' 小時') %}{% endif %}
                            {% if minutes > 0 %}{% set _ = parts.append(minutes ~ ' 分鐘') %}{% endif %}
                            {% if seconds > 0 or parts|length == 0 %}
                                {% if seconds == seconds|int %}
                                    {% set _ = parts.append((seconds|int) ~ ' 秒') %}
                                {% else %}
                                    {% set _ = parts.append(seconds ~ ' 秒') %}
                                {% endif %}
                            {% endif %}
                            每隔 {{ parts|join(' ') }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600 text-sm">錄音時長</span>
                        <span class="font-medium text-sm text-gray-900">{{ schedule.duration_seconds or 60 }} 秒</span>
                    </div>
                </div>

                <div class="flex gap-2 mt-4">
                    <button onclick="deviceDetail.toggleSchedule({% if schedule.enabled %}false{% else %}true{% endif %})"
                            class="flex-1 px-3 py-2 rounded-lg font-medium text-sm transition-colors
                                {% if schedule.enabled %}
                                    bg-gray-100 text-gray-700 hover:bg-gray-200
                                {% else %}
                                    bg-emerald-500 text-white hover:bg-emerald-600
                                {% endif %}">
                        {% if schedule.enabled %}
                            <i class="fas fa-pause mr-1"></i> 停用
                        {% else %}
                            <i class="fas fa-play mr-1"></i> 啟用
                        {% endif %}
                    </button>
                </div>
            </div>

            <!-- 路由配置 -->
            <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-gray-800">
                        <i class="fas fa-route mr-2 text-purple-500"></i>路由配置
                    </h4>
                </div>

                {% set assigned_routers = device.assigned_router_ids or [] %}
                {% if assigned_routers %}
                <div class="space-y-3 max-h-48 overflow-y-auto">
                    {% for router in available_routers %}
                        {% if router.rule_id in assigned_routers %}
                        <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm text-emerald-700">{{ router.rule_name }}</span>
                                <span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded">優先 {{ router.priority }}</span>
                            </div>
                            <p class="text-xs text-gray-600">{{ router.description or '無描述' }}</p>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6 bg-gray-50 rounded-lg">
                    <i class="fas fa-route text-3xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500 text-sm">尚未配置任何路由</p>
                    <p class="text-xs text-gray-400 mt-1">點擊「編輯所有設定」按鈕選擇分析路由</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 近期錄音 -->
<div class="tech-card overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">近期錄音</h3>
        <a href="{{ url_for('views.edge_device_recordings', device_id=device.device_id) }}"
           class="text-sm text-emerald-600 hover:text-emerald-700">
            查看全部 <i class="fas fa-arrow-right ml-1"></i>
        </a>
    </div>
    <div id="recent-recordings-container" class="overflow-x-auto">
        {% if recent_recordings %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">#</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分析 UUID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">檔案名稱</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時長</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分析路由</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">建立時間</th>
                </tr>
            </thead>
            <tbody id="recent-recordings-tbody" class="bg-white divide-y divide-gray-200">
                {% for recording in recent_recordings %}
                <tr class="hover:bg-gray-50">
                    <td class="row-number px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-400">{{ loop.index }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">
                        <a href="{{ url_for('views.data_detail', analyze_uuid=recording.analyze_uuid) }}"
                           class="text-emerald-600 hover:text-emerald-700 hover:underline">
                            {{ recording.analyze_uuid[:16] }}...
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ recording.filename or '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if recording.duration is not none %}{{ "%.1f"|format(recording.duration) }}{% else %}-{% endif %}s
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {% if recording.assigned_router_ids %}
                            <span class="tech-badge text-xs bg-emerald-100 text-emerald-700">
                                {{ recording.assigned_router_ids|length }} 個路由
                            </span>
                        {% else %}
                            <span class="tech-badge text-xs bg-gray-100 text-gray-600">無</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if recording.created_at %}
                            {{ recording.created_at | to_taipei_tz('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div id="no-recordings-placeholder" class="px-6 py-12 text-center">
            <i class="fas fa-file-audio text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">尚無錄音記錄</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 刪除確認 Modal -->
<div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="delete-confirm-content">
        <div class="px-6 py-4 border-b border-gray-100 bg-red-50">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-red-800">確認刪除設備</h3>
            </div>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">您確定要刪除此設備嗎？</p>
            <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                        <i class="fas fa-satellite-dish text-white"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900" id="delete-device-name">{{ device.device_name or '未命名設備' }}</p>
                        <p class="text-xs text-gray-500 font-mono">{{ device.device_id[:24] }}...</p>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200">
                <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-amber-600 mt-0.5"></i>
                    <p class="text-sm text-amber-800">此操作無法復原，設備的所有配置資料將會被永久刪除。</p>
                </div>
            </div>
            <!-- 刪除錄音資料選項 -->
            <div class="mt-4">
                <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="checkbox" id="delete-recordings-checkbox"
                           class="mt-1 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <div>
                        <span class="font-medium text-gray-900">同時刪除該設備的所有錄音資料</span>
                        <p class="text-xs text-gray-500 mt-1">
                            共 <span class="font-semibold text-red-600">{{ device_stats.get('total_recordings', 0)|default(0, true) }}</span> 筆錄音，包含音訊檔案與分析記錄
                        </p>
                    </div>
                </label>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-2">
            <button onclick="deviceDetail.closeDeleteConfirmModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                取消
            </button>
            <button onclick="deviceDetail.confirmDeleteDevice('{{ url_for('views.edge_devices_list') }}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                <i class="fas fa-trash-alt mr-1"></i>確認刪除
            </button>
        </div>
    </div>
</div>

<!-- 統一編輯配置 Modal -->
<div id="unified-config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 max-h-[95vh] min-h-[70vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-edit mr-2 text-emerald-500"></i>編輯所有設定
            </h3>
            <p class="text-sm text-gray-500 mt-1">一次修改設備資訊、音訊參數、排程錄音與分析路由設定</p>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <!-- 第一行：設備資訊（3欄） -->
            <div class="mb-6 pb-6 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-4">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>設備資訊
                </h4>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 欄1：基本資訊 + 照片 -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">設備照片</label>
                            <div class="flex items-center gap-3">
                                <div id="unified-photo-preview" class="h-16 w-16 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center flex-shrink-0">
                                    {% if device.photo_path %}
                                    <img src="{{ url_for('edge_device_api.get_device_photo', device_id=device.device_id) }}"
                                         alt="設備照片" class="h-full w-full object-cover">
                                    {% else %}
                                    <i class="fas fa-camera text-gray-400"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="unified-photo-input" accept="image/*" class="hidden"
                                           onchange="deviceDetail.previewUnifiedPhoto(this)">
                                    <button type="button" onclick="document.getElementById('unified-photo-input').click()"
                                            class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-upload mr-1"></i>上傳照片
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1">支援 JPG、PNG 格式</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">設備名稱</label>
                            <input type="text" id="unified-device-name" value="{{ device.device_name or '' }}"
                                   placeholder="輸入設備名稱"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">設備 ID</label>
                            <input type="text" value="{{ device.device_id }}"
                                   class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-500 text-sm cursor-not-allowed truncate"
                                   readonly disabled>
                        </div>
                    </div>
                    <!-- 欄2：位置資訊 -->
                    <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                        {% set location = device.location or {} %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">位置名稱</label>
                            <input type="text" id="unified-location-name" value="{{ location.name or '' }}"
                                   placeholder="例如：主機房"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">建築物</label>
                                <input type="text" id="unified-location-building" value="{{ location.building or '' }}"
                                       placeholder="A 棟"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">樓層</label>
                                <input type="text" id="unified-location-floor" value="{{ location.floor or '' }}"
                                       placeholder="3F"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">房間</label>
                            <input type="text" id="unified-location-room" value="{{ location.room or '' }}"
                                   placeholder="301 室"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                        </div>
                    </div>
                    <!-- 欄3：管理人員 -->
                    <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">管理人員</label>
                            <p class="text-xs text-gray-500 mb-2">選擇負責管理此設備的用戶</p>
                        </div>
                        <div id="unified-managers-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                <p class="text-xs text-gray-500 mt-1">載入中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二行：設備配置（3欄） -->
            <div>
                <h4 class="font-semibold text-gray-800 mb-4">
                    <i class="fas fa-sliders-h mr-2 text-emerald-500"></i>設備配置
                </h4>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 欄1：音訊配置 -->
                    <div class="space-y-4">
                        <h5 class="text-sm font-medium text-gray-700">
                            <i class="fas fa-microphone mr-2 text-orange-500"></i>音訊配置
                        </h5>
                        {% set audio = device.audio_config or {} %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">音訊設備</label>
                            <div class="flex gap-2">
                                <select id="unified-audio-device-index" class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                {% if audio.available_devices %}
                                    {% for dev in audio.available_devices %}
                                    <option value="{{ dev.index }}" {% if dev.index == audio.default_device_index %}selected{% endif %}>
                                        {{ dev.index }}: {{ dev.name }}
                                    </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="{{ audio.default_device_index or 0 }}">設備 {{ audio.default_device_index or 0 }}</option>
                                {% endif %}
                                </select>
                                <button type="button" onclick="deviceDetail.queryAudioDevicesInModal()"
                                        class="flex-shrink-0 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                        title="查詢可用的音訊設備">
                                    <i class="fas fa-sync-alt" id="unified-query-icon"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="unified-audio-device-hint">點擊重新整理按鈕查詢可用設備</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">取樣率 (Hz)</label>
                            <select id="unified-audio-sample-rate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                <option value="8000" {% if audio.sample_rate == 8000 %}selected{% endif %}>8000</option>
                                <option value="16000" {% if audio.sample_rate == 16000 or not audio.sample_rate %}selected{% endif %}>16000</option>
                                <option value="22050" {% if audio.sample_rate == 22050 %}selected{% endif %}>22050</option>
                                <option value="44100" {% if audio.sample_rate == 44100 %}selected{% endif %}>44100</option>
                                <option value="48000" {% if audio.sample_rate == 48000 %}selected{% endif %}>48000</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">聲道數</label>
                                <select id="unified-audio-channels" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                    <option value="1" {% if audio.channels == 1 or not audio.channels %}selected{% endif %}>單聲道</option>
                                    <option value="2" {% if audio.channels == 2 %}selected{% endif %}>立體聲</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">位元深度</label>
                                <select id="unified-audio-bit-depth" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                    <option value="16" {% if audio.bit_depth == 16 or not audio.bit_depth %}selected{% endif %}>16 bit</option>
                                    <option value="24" {% if audio.bit_depth == 24 %}selected{% endif %}>24 bit</option>
                                    <option value="32" {% if audio.bit_depth == 32 %}selected{% endif %}>32 bit</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- 欄2：排程配置 -->
                    <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                        <h5 class="text-sm font-medium text-gray-700">
                            <i class="fas fa-clock mr-2 text-blue-500"></i>排程配置
                        </h5>
                        {% set schedule = device.schedule_config or {} %}
                        {% set interval_secs = schedule.interval_seconds or 3600 %}
                        {# 計算最適合的顯示單位和數值 #}
                        {% if interval_secs >= 86400 and interval_secs % 86400 == 0 %}
                            {% set interval_display = (interval_secs // 86400) | int %}
                            {% set interval_unit = '86400' %}
                        {% elif interval_secs >= 3600 and interval_secs % 3600 == 0 %}
                            {% set interval_display = (interval_secs // 3600) | int %}
                            {% set interval_unit = '3600' %}
                        {% elif interval_secs >= 60 and interval_secs % 60 == 0 %}
                            {% set interval_display = (interval_secs // 60) | int %}
                            {% set interval_unit = '60' %}
                        {% else %}
                            {% set interval_display = interval_secs %}
                            {% set interval_unit = '1' %}
                        {% endif %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">排程狀態</label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="unified-schedule-enabled" {% if schedule.enabled %}checked{% endif %}
                                       class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                <span class="ml-2 text-sm text-gray-700">啟用自動排程錄音</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">間隔時間</label>
                            <div class="flex gap-2">
                                <input type="number" id="unified-schedule-interval"
                                       value="{{ interval_display }}"
                                       min="0.1" step="0.1"
                                       class="flex-[3] min-w-0 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                <select id="unified-schedule-interval-unit" class="flex-1 w-20 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                    <option value="1" {% if interval_unit == '1' %}selected{% endif %}>秒</option>
                                    <option value="60" {% if interval_unit == '60' %}selected{% endif %}>分鐘</option>
                                    <option value="3600" {% if interval_unit == '3600' %}selected{% endif %}>小時</option>
                                    <option value="86400" {% if interval_unit == '86400' %}selected{% endif %}>天</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">間隔時間不可小於錄音時長</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">錄音時長（秒）</label>
                            <input type="number" id="unified-schedule-duration" value="{{ schedule.duration_seconds or 60 }}"
                                   min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                        </div>
                    </div>
                    <!-- 欄3：路由配置 -->
                    <div class="space-y-4 lg:border-l lg:border-gray-200 lg:pl-6">
                        <h5 class="text-sm font-medium text-gray-700">
                            <i class="fas fa-route mr-2 text-purple-500"></i>路由配置
                        </h5>
                        {% if available_routers %}
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            {% for router in available_routers %}
                            <label class="flex items-start p-3 rounded-lg border border-gray-200 hover:border-emerald-300 cursor-pointer transition-colors">
                                <input type="checkbox" name="unified_router_ids" value="{{ router.rule_id }}"
                                       class="unified-router-checkbox mt-0.5 h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500"
                                       {% if router.rule_id in (device.assigned_router_ids or []) %}checked{% endif %}>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <span class="font-medium text-sm text-gray-900">{{ router.rule_name }}</span>
                                        <span class="text-xs text-gray-500">優先 {{ router.priority }}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-0.5">{{ router.description or '無描述' }}</p>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-6 bg-gray-50 rounded-lg">
                            <i class="fas fa-route text-3xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500 text-sm">目前沒有可用的路由規則</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-2">
            <button onclick="deviceDetail.closeUnifiedConfigModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                取消
            </button>
            <button onclick="deviceDetail.saveUnifiedConfig()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                <i class="fas fa-save mr-1"></i>儲存所有設定
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/edge_device_detail.js') }}"></script>
<script>
    // 初始化設備詳情控制器
    const deviceDetail = new EdgeDeviceDetail(
        '{{ device.device_id }}',
        {{ (device.manager_ids or []) | tojson }}
    );
</script>
{% endblock %}
