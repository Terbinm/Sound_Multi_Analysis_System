{% extends "base.html" %}
{% from "macros/json_display.html" import json_viewer %}
{% block title %}錄音詳情{% endblock %}
{% block page_title %}錄音詳情{% endblock %}

{% block extra_css %}
<style>
    .fft-canvas {
        width: 100%;
        height: 120px;
        border-radius: 0.5rem;
    }
    .audio-progress-container {
        position: relative;
        height: 8px;
        background: #374151;
        border-radius: 4px;
        cursor: pointer;
    }
    .audio-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 4px;
        transition: width 0.1s ease;
    }
    .volume-slider {
        -webkit-appearance: none;
        width: 80px;
        height: 4px;
        background: #374151;
        border-radius: 2px;
        outline: none;
    }
    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 標題與操作按鈕 -->
    <div class="tech-card">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">分析 UUID</h3>
                    <p class="text-sm text-gray-600 mt-1 font-mono">{{ record.AnalyzeUUID }}</p>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    <a href="{{ url_for('data_api.download_audio', analyze_uuid=record.AnalyzeUUID) }}"
                       class="tech-button-primary">
                        <i class="fas fa-download mr-2"></i>下載音訊
                    </a>
                    <button onclick="confirmDelete()" class="tech-button-danger">
                        <i class="fas fa-trash mr-2"></i>刪除錄音
                    </button>
                    <a href="{{ url_for('views.data_list') }}" class="tech-button-outline">
                        <i class="fas fa-arrow-left mr-2"></i>返回列表
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 音訊播放器與 FFT 可視化 -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-waveform-path mr-2 text-blue-500"></i>音訊播放器
            </h4>
        </div>
        <div class="px-6 py-4">
            <!-- FFT 畫布 -->
            <canvas id="fftCanvas" class="fft-canvas bg-gray-800 mb-4"></canvas>

            <!-- 播放控制 -->
            <div class="flex items-center gap-4">
                <!-- 播放/暫停按鈕 -->
                <button id="playPauseBtn" class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition-colors">
                    <i id="playPauseIcon" class="fas fa-play"></i>
                </button>

                <!-- 進度條 -->
                <div class="flex-1">
                    <div id="progressContainer" class="audio-progress-container">
                        <div id="progressBar" class="audio-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-xs text-gray-500">
                        <span id="currentTime">00:00</span>
                        <span id="duration">00:00</span>
                    </div>
                </div>

                <!-- 音量控制 -->
                <div class="flex items-center gap-2">
                    <i class="fas fa-volume-up text-gray-500"></i>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="100">
                </div>
            </div>

            <!-- 播放器狀態 -->
            <div id="playerStatus" class="mt-3 text-sm text-gray-500 hidden">
                <i class="fas fa-info-circle mr-1"></i>
                <span id="playerStatusText"></span>
            </div>
        </div>
    </div>

    <!-- 音訊資訊 & 設備資訊 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- 音訊資訊 -->
        <div class="tech-card">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h4 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-music mr-2 text-purple-500"></i>音訊資訊
                </h4>
            </div>
            <div class="px-6 py-4 space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-500">檔案名稱</span>
                    <span class="text-gray-800 font-medium">{{ record.get('files', {}).get('raw', {}).get('filename') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">時長</span>
                    <span class="text-gray-800 font-medium">{{ record.get('info_features', {}).get('duration') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">取樣率</span>
                    <span class="text-gray-800 font-medium">
                        {% set sr = record.get('info_features', {}).get('sample_rate') %}
                        {% if sr %}{{ sr }} Hz{% else %}N/A{% endif %}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">聲道數</span>
                    <span class="text-gray-800 font-medium">
                        {% set ch = record.get('info_features', {}).get('channels') %}
                        {% if ch %}{{ ch }}{% else %}N/A{% endif %}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">檔案大小</span>
                    <span class="text-gray-800 font-medium">
                        {% set size = record.get('info_features', {}).get('file_size') %}
                        {% if size %}
                            {{ (size / 1024 / 1024)|round(2) }} MB
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">建立時間</span>
                    <span class="text-gray-800 font-medium">{{ record.get('created_at') or '-' }}</span>
                </div>
            </div>
        </div>

        <!-- 錄製設備資訊 -->
        <div class="tech-card">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h4 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-microphone mr-2 text-green-500"></i>錄製設備
                </h4>
            </div>
            <div class="px-6 py-4 space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-500">設備 ID</span>
                    <span class="text-gray-800 font-medium font-mono">{{ record.get('info_features', {}).get('device_id') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">設備名稱</span>
                    <span class="text-gray-800 font-medium">{{ record.get('info_features', {}).get('device_name') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">來源</span>
                    <span class="text-gray-800 font-medium">{{ record.get('info_features', {}).get('upload_source') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">資料集 UUID</span>
                    <span class="text-gray-800 font-medium font-mono text-xs">{{ record.get('info_features', {}).get('dataset_UUID') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">上傳者</span>
                    <span class="text-gray-800 font-medium">{{ record.get('info_features', {}).get('uploaded_by') or '-' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">上傳時間</span>
                    <span class="text-gray-800 font-medium">{{ record.get('info_features', {}).get('upload_time') or '-' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 最新分析結果摘要 -->
    {% if latest_run %}
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white flex items-center justify-between">
            <div>
                <h4 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-line mr-2 text-orange-500"></i>最新分析結果
                </h4>
                <p class="text-xs text-gray-500 mt-1">Run {{ latest_run.index }} - {{ latest_run.analysis_id }}</p>
            </div>
            <a href="{{ url_for('views.run_detail', analyze_uuid=record.AnalyzeUUID, analysis_id=latest_run.analysis_id) }}"
               class="tech-button-outline text-sm">
                查看詳情 <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="px-6 py-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <div class="text-xs text-gray-500 uppercase font-semibold">狀態</div>
                    <div class="mt-2">
                        <span class="tech-badge
                            {% if latest_run.status == 'completed' %} tech-badge-success
                            {% elif latest_run.status == 'processing' %} tech-badge-info
                            {% elif latest_run.status == 'failed' %} tech-badge-danger
                            {% else %} tech-badge-warning {% endif %}">
                            {% if latest_run.status == 'completed' %}已完成
                            {% elif latest_run.status == 'processing' %}處理中
                            {% elif latest_run.status == 'failed' %}失敗
                            {% else %}{{ latest_run.status }}{% endif %}
                        </span>
                    </div>
                </div>
                {% if latest_run.analysis_summary %}
                    {% if latest_run.analysis_summary.final_prediction %}
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase font-semibold">預測結果</div>
                        <div class="text-lg font-bold text-gray-800 mt-1">{{ latest_run.analysis_summary.final_prediction }}</div>
                    </div>
                    {% endif %}
                    {% if latest_run.analysis_summary.confidence %}
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xs text-gray-500 uppercase font-semibold">信心度</div>
                        <div class="text-lg font-bold text-gray-800 mt-1">{{ (latest_run.analysis_summary.confidence * 100)|round(1) }}%</div>
                    </div>
                    {% endif %}
                {% endif %}
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <div class="text-xs text-gray-500 uppercase font-semibold">分析方法</div>
                    <div class="text-sm font-medium text-gray-800 mt-2">{{ latest_run.analysis_method_id or '-' }}</div>
                </div>
            </div>

            <!-- 其他摘要項目 -->
            {% if latest_run.analysis_summary %}
            <div class="mt-4 flex flex-wrap gap-2">
                {% for key, val in latest_run.analysis_summary.items() %}
                    {% if key not in ['final_prediction', 'confidence'] %}
                    <span class="tech-badge tech-badge-secondary">{{ key }}: {{ val }}</span>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 分析執行紀錄（可點擊跳轉） -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white flex items-center justify-between">
            <h4 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-history mr-2 text-indigo-500"></i>分析執行紀錄
            </h4>
            <span class="tech-badge tech-badge-secondary">{{ runs|length }} 次執行</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">分析 ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">方法</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">開始時間</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">完成時間</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for run in runs %}
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='{{ url_for('views.run_detail', analyze_uuid=record.AnalyzeUUID, analysis_id=run.analysis_id) }}'">
                        <td class="px-4 py-3 text-sm text-gray-700">{{ run.index }}</td>
                        <td class="px-4 py-3 text-sm font-mono text-gray-700">{{ run.analysis_id[:16] }}...</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ run.analysis_method_id or '-' }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="tech-badge
                                {% if run.status == 'completed' %}tech-badge-success
                                {% elif run.status == 'processing' %}tech-badge-info
                                {% elif run.status == 'failed' %}tech-badge-danger
                                {% else %}tech-badge-warning{% endif %}">
                                {% if run.status == 'completed' %}已完成
                                {% elif run.status == 'processing' %}處理中
                                {% elif run.status == 'failed' %}失敗
                                {% else %}{{ run.status }}{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-600">{{ run.started_at or '-' }}</td>
                        <td class="px-4 py-3 text-xs text-gray-600">{{ run.completed_at or '-' }}</td>
                        <td class="px-4 py-3 text-sm" onclick="event.stopPropagation()">
                            <a href="{{ url_for('views.run_detail', analyze_uuid=record.AnalyzeUUID, analysis_id=run.analysis_id) }}"
                               class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye"></i> 查看
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-4 py-6 text-center text-sm text-gray-500">尚無分析執行紀錄</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 任務執行日誌 -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-tasks mr-2 text-cyan-500"></i>任務執行日誌
            </h4>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">任務 ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">路由</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">配置</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">節點</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">{{ log.task_id[:16] if log.task_id else '-' }}...</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ log.router_id or '-' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ log.config_id[:16] if log.config_id else '-' }}...</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="tech-badge
                                {% if log.status == 'completed' %}tech-badge-success
                                {% elif log.status == 'processing' %}tech-badge-info
                                {% elif log.status == 'failed' %}tech-badge-danger
                                {% else %}tech-badge-warning{% endif %}">
                                {% if log.status == 'completed' %}已完成
                                {% elif log.status == 'processing' %}處理中
                                {% elif log.status == 'failed' %}失敗
                                {% elif log.status == 'pending' %}等待中
                                {% else %}{{ log.status }}{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ log.node_id or '-' }}</td>
                        <td class="px-4 py-3 text-xs text-gray-600">
                            <div>{{ log.created_at }}</div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500">尚無任務日誌</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 原始資料區塊（懶加載） -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- info_features -->
        <div class="tech-card">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer select-none"
                 onclick="toggleFeatures('info_features')">
                <div class="flex items-center justify-between">
                    <h4 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-database mr-2 text-blue-500"></i>info_features
                    </h4>
                    <i id="info_features_icon" class="fas fa-chevron-right text-gray-400 transition-transform duration-200"></i>
                </div>
            </div>
            <div id="info_features_content" class="hidden">
                <div id="info_features_loader" class="px-6 py-8 text-center">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <p class="text-sm text-gray-500 mt-2">載入中...</p>
                </div>
                <div id="info_features_data" class="px-6 py-4 hidden"></div>
            </div>
        </div>

        <!-- analyze_features -->
        <div class="tech-card">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer select-none"
                 onclick="toggleFeatures('analyze_features')">
                <div class="flex items-center justify-between">
                    <h4 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-bar mr-2 text-purple-500"></i>analyze_features
                    </h4>
                    <i id="analyze_features_icon" class="fas fa-chevron-right text-gray-400 transition-transform duration-200"></i>
                </div>
            </div>
            <div id="analyze_features_content" class="hidden">
                <div id="analyze_features_loader" class="px-6 py-8 text-center">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <p class="text-sm text-gray-500 mt-2">載入中...</p>
                </div>
                <div id="analyze_features_data" class="px-6 py-4 hidden"></div>
            </div>
        </div>
    </div>

</div>

<!-- 刪除確認彈窗 -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>確認刪除
        </h3>
        <p class="text-gray-600 mb-6">
            確定要刪除此錄音嗎？此操作無法復原。
            所有相關檔案和任務日誌都將被永久刪除。
        </p>
        <div class="flex justify-end gap-4">
            <button onclick="closeDeleteModal()" class="tech-button-outline">取消</button>
            <button onclick="deleteRecording()" class="tech-button-danger">
                <i class="fas fa-trash mr-2"></i>刪除
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/audio_player.js') }}"></script>
<script>
    // 初始化音訊播放器
    const analyzeUUID = '{{ record.AnalyzeUUID }}';
    const audioUrl = '{{ url_for("data_api.stream_audio", analyze_uuid=record.AnalyzeUUID) }}';
    const canvas = document.getElementById('fftCanvas');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volumeSlider');
    const playerStatus = document.getElementById('playerStatus');
    const playerStatusText = document.getElementById('playerStatusText');

    // 設定畫布大小
    canvas.width = canvas.offsetWidth;
    canvas.height = 120;

    // 建立播放器instance
    const player = new AudioFFTPlayer({
        onPlay: () => {
            playPauseIcon.className = 'fas fa-pause';
        },
        onPause: () => {
            playPauseIcon.className = 'fas fa-play';
        },
        onEnded: () => {
            playPauseIcon.className = 'fas fa-play';
            progressBar.style.width = '0%';
        },
        onTimeUpdate: ({ currentTime, duration }) => {
            currentTimeEl.textContent = AudioFFTPlayer.formatTime(currentTime);
            if (duration && isFinite(duration)) {
                progressBar.style.width = `${(currentTime / duration) * 100}%`;
            }
        },
        onLoadedMetadata: ({ duration }) => {
            durationEl.textContent = AudioFFTPlayer.formatTime(duration);
        },
        onError: (e) => {
            playerStatus.classList.remove('hidden');
            playerStatusText.textContent = '載入音訊時發生錯誤：' + (e.message || '未知錯誤');
            console.error('音訊錯誤:', e);
        }
    });

    // 初始化播放器
    player.init(audioUrl, canvas);

    // 播放/暫停按鈕
    playPauseBtn.addEventListener('click', () => {
        player.togglePlay();
    });

    // 進度條點擊
    progressContainer.addEventListener('click', (e) => {
        const rect = progressContainer.getBoundingClientRect();
        const percent = ((e.clientX - rect.left) / rect.width) * 100;
        player.seekPercent(percent);
    });

    // 音量控制
    volumeSlider.addEventListener('input', (e) => {
        player.setVolume(e.target.value / 100);
    });

    // 處理視窗大小調整
    window.addEventListener('resize', () => {
        canvas.width = canvas.offsetWidth;
    });

    // 刪除功能
    function confirmDelete() {
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
    }

    async function deleteRecording() {
        try {
            const response = await fetch(`/api/data/${analyzeUUID}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                alert('錄音已成功刪除');
                window.location.href = '{{ url_for("views.data_list") }}';
            } else {
                alert('刪除失敗：' + (result.error || '未知錯誤'));
            }
        } catch (error) {
            console.error('刪除錯誤:', error);
            alert('刪除錄音時發生錯誤：' + error.message);
        }

        closeDeleteModal();
    }

    // ===== Features 懶加載功能 =====
    const featuresCache = {};
    const featuresExpanded = {
        info_features: false,
        analyze_features: false
    };

    async function toggleFeatures(featureType) {
        const content = document.getElementById(`${featureType}_content`);
        const icon = document.getElementById(`${featureType}_icon`);
        const loader = document.getElementById(`${featureType}_loader`);
        const dataContainer = document.getElementById(`${featureType}_data`);

        if (featuresExpanded[featureType]) {
            // 收合
            content.classList.add('hidden');
            icon.classList.remove('rotate-90');
            featuresExpanded[featureType] = false;
        } else {
            // 展開
            content.classList.remove('hidden');
            icon.classList.add('rotate-90');
            featuresExpanded[featureType] = true;

            // 檢查是否已載入
            if (!featuresCache[featureType]) {
                // 顯示載入中
                loader.classList.remove('hidden');
                dataContainer.classList.add('hidden');

                try {
                    const typeParam = featureType === 'info_features' ? 'info' : 'analyze';
                    const response = await fetch(`/api/data/${analyzeUUID}/features?type=${typeParam}`);
                    const result = await response.json();

                    if (result.success) {
                        const data = result.data[featureType] || {};
                        featuresCache[featureType] = data;
                        renderJsonData(dataContainer, data);
                    } else {
                        dataContainer.innerHTML = `<p class="text-red-500">載入失敗: ${result.error}</p>`;
                    }
                } catch (error) {
                    console.error('載入 features 失敗:', error);
                    dataContainer.innerHTML = `<p class="text-red-500">載入失敗: ${error.message}</p>`;
                }

                // 隱藏載入中，顯示數據
                loader.classList.add('hidden');
                dataContainer.classList.remove('hidden');
            }
        }
    }

    function renderJsonData(container, data) {
        // 創建簡單的 JSON 顯示
        const isEmpty = !data || Object.keys(data).length === 0;

        if (isEmpty) {
            container.innerHTML = '<p class="text-gray-500 text-sm">無資料</p>';
            return;
        }

        const html = createJsonHtml(data, 0);
        container.innerHTML = `<pre class="json-viewer text-sm font-mono overflow-x-auto bg-gray-50 p-4 rounded-lg whitespace-pre-wrap break-words">${html}</pre>`;
    }

    function createJsonHtml(obj, depth) {
        if (obj === null) return '<span class="text-gray-500">null</span>';
        if (obj === undefined) return '<span class="text-gray-500">undefined</span>';

        const type = typeof obj;

        if (type === 'string') {
            return `<span class="text-green-600">"${escapeHtml(obj)}"</span>`;
        }
        if (type === 'number') {
            return `<span class="text-blue-600">${obj}</span>`;
        }
        if (type === 'boolean') {
            return `<span class="text-purple-600">${obj}</span>`;
        }

        if (Array.isArray(obj)) {
            if (obj.length === 0) return '<span class="text-gray-500">[]</span>';

            const items = obj.map((item, i) => {
                const indent = '  '.repeat(depth + 1);
                return `${indent}${createJsonHtml(item, depth + 1)}`;
            }).join(',\n');

            const closeIndent = '  '.repeat(depth);
            return `[\n${items}\n${closeIndent}]`;
        }

        if (type === 'object') {
            const keys = Object.keys(obj);
            if (keys.length === 0) return '<span class="text-gray-500">{}</span>';

            const items = keys.map(key => {
                const indent = '  '.repeat(depth + 1);
                return `${indent}<span class="text-red-600">"${escapeHtml(key)}"</span>: ${createJsonHtml(obj[key], depth + 1)}`;
            }).join(',\n');

            const closeIndent = '  '.repeat(depth);
            return `{\n${items}\n${closeIndent}}`;
        }

        return String(obj);
    }

    function escapeHtml(str) {
        if (typeof str !== 'string') return str;
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    // 頁面卸載時清理
    window.addEventListener('beforeunload', () => {
        player.destroy();
    });
</script>
{% endblock %}
