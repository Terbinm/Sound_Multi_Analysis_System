{% extends "base.html" %}
{% from "macros/json_display.html" import json_viewer %}
{% block title %}Run {{ run.index }} - {{ record.AnalyzeUUID[:8] }}{% endblock %}
{% block page_title %}Run Details{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center space-x-2 text-sm text-gray-500">
        <a href="{{ url_for('views.data_list') }}" class="hover:text-blue-600">Data</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <a href="{{ url_for('views.data_detail', analyze_uuid=record.AnalyzeUUID) }}" class="hover:text-blue-600 font-mono">{{ record.AnalyzeUUID[:8] }}...</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <span class="text-gray-900">Run {{ run.index }}</span>
    </nav>

    <!-- Run Header -->
    <div class="tech-card">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Run {{ run.index }}</h3>
                    <p class="text-sm text-gray-500 mt-1 font-mono">{{ run.analysis_id }}</p>
                </div>
                <span class="tech-badge text-sm
                    {% if run.status == 'completed' %} tech-badge-success
                    {% elif run.status == 'processing' %} tech-badge-info
                    {% elif run.status == 'failed' %} tech-badge-danger
                    {% else %} tech-badge-warning {% endif %}">
                    <i class="fas {% if run.status == 'completed' %}fa-check-circle{% elif run.status == 'processing' %}fa-spinner fa-spin{% elif run.status == 'failed' %}fa-times-circle{% else %}fa-clock{% endif %} mr-1"></i>
                    {{ run.status }}
                </span>
            </div>
        </div>

        <!-- Execution Status -->
        <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-b border-gray-100">
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Requested At</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.requested_at or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Started At</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.started_at or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Completed At</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.completed_at or '-' }}</dd>
            </div>
        </div>

        <!-- Duration calculation if available -->
        {% if run.started_at and run.completed_at %}
        <div class="px-6 py-3 bg-gray-50 border-b border-gray-100">
            <span class="text-xs text-gray-500 uppercase font-semibold">Duration: </span>
            <span class="text-sm text-gray-700">
                {% set start = run.started_at %}
                {% set end = run.completed_at %}
                Calculated on render
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Analysis Context -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">Analysis Context</h4>
        </div>
        <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Router ID</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.router_id or '-' }}</dd>
                {% if router_name %}
                <dd class="text-xs text-gray-500">{{ router_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Routing Rule</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.routing_rule_id or '-' }}</dd>
                {% if rule_name %}
                <dd class="text-xs text-gray-500">{{ rule_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Analysis Config</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.analysis_config_id or '-' }}</dd>
                {% if config_name %}
                <dd class="text-xs text-gray-500">{{ config_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Analysis Method</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.analysis_method_id or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">Node ID</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.node_id or '-' }}</dd>
            </div>
        </div>
    </div>

    <!-- Analysis Summary -->
    {% if run.analysis_summary %}
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">Analysis Summary</h4>
        </div>
        <div class="px-6 py-4">
            <div class="flex flex-wrap gap-3">
                {% for key, val in run.analysis_summary.items() %}
                <div class="bg-gray-100 rounded-lg px-4 py-2">
                    <span class="text-xs text-gray-500 uppercase block">{{ key }}</span>
                    <span class="text-sm font-semibold text-gray-800">{{ val }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if run.error_message %}
    <div class="tech-card border-l-4 border-red-500">
        <div class="px-6 py-4">
            <h4 class="text-sm font-semibold text-red-600 uppercase mb-2">Error Message</h4>
            <pre class="text-sm text-red-800 bg-red-50 p-3 rounded overflow-x-auto">{{ run.error_message }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- Processing Steps -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">Processing Steps</h4>
            <p class="text-xs text-gray-500 mt-1">{{ run.steps|length }} step(s)</p>
        </div>
        <div class="px-6 py-4">
            {% if run.steps %}
            <div class="space-y-4">
                {% for step in run.steps %}
                <div class="border rounded-lg p-4 {% if step.features_state == 'completed' %}border-green-200 bg-green-50{% elif step.features_state == 'failed' or step.features_state == 'error' %}border-red-200 bg-red-50{% elif step.features_state == 'processing' %}border-blue-200 bg-blue-50{% else %}border-gray-200{% endif %}">
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="font-semibold text-gray-900">{{ step.name or step.features_name or 'Step ' ~ loop.index }}</h5>
                        <span class="tech-badge text-xs
                            {% if step.features_state == 'completed' %}tech-badge-success
                            {% elif step.features_state == 'processing' %}tech-badge-info
                            {% elif step.features_state == 'failed' or step.features_state == 'error' %}tech-badge-danger
                            {% else %}tech-badge-warning{% endif %}">
                            {{ step.features_state or 'unknown' }}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        {% if step.started_at %}
                        <div>
                            <span class="text-gray-500">Started:</span>
                            <span class="text-gray-700">{{ step.started_at }}</span>
                        </div>
                        {% endif %}
                        {% if step.completed_at %}
                        <div>
                            <span class="text-gray-500">Completed:</span>
                            <span class="text-gray-700">{{ step.completed_at }}</span>
                        </div>
                        {% endif %}
                        {% if step.processor_metadata %}
                        <div class="md:col-span-2">
                            <span class="text-gray-500">Processor Info:</span>
                            <pre class="text-xs bg-white p-2 rounded mt-1 overflow-x-auto">{{ step.processor_metadata | tojson(indent=2) }}</pre>
                        </div>
                        {% endif %}
                        {% if step.features_data %}
                        <div class="md:col-span-2">
                            <span class="text-gray-500">Data Records:</span>
                            <span class="text-gray-700">{{ step.features_data|length }} entries</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">No processing steps recorded.</p>
            {% endif %}
        </div>
    </div>

    <!-- Raw JSON Data -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">Raw Data</h4>
        </div>
        <div class="px-6 py-4 space-y-4">
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">Analysis Context (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.analysis_context, 'analysis_context_raw', collapsed=false) }}
                </div>
            </details>
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">Steps (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.steps, 'steps_raw', collapsed=false) }}
                </div>
            </details>
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">Analysis Summary (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.analysis_summary, 'summary_raw', collapsed=false) }}
                </div>
            </details>
        </div>
    </div>

    <!-- Navigation: Other Runs -->
    {% if runs|length > 1 %}
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">Other Runs</h4>
        </div>
        <div class="px-6 py-4">
            <div class="flex flex-wrap gap-2">
                {% for r in runs %}
                {% if r.analysis_id != run.analysis_id %}
                <a href="{{ url_for('views.run_detail', analyze_uuid=record.AnalyzeUUID, analysis_id=r.analysis_id) }}"
                   class="inline-flex items-center px-3 py-1.5 rounded-lg border
                          {% if r.status == 'completed' %}border-green-300 bg-green-50 text-green-700 hover:bg-green-100
                          {% elif r.status == 'failed' %}border-red-300 bg-red-50 text-red-700 hover:bg-red-100
                          {% elif r.status == 'processing' %}border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100
                          {% else %}border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}
                          transition-colors">
                    <span class="text-sm font-medium">Run {{ r.index }}</span>
                    <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </a>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="flex justify-between">
        <a href="{{ url_for('views.data_detail', analyze_uuid=record.AnalyzeUUID) }}" class="tech-button-outline">
            <i class="fas fa-arrow-left mr-2"></i>Back to Recording
        </a>
    </div>
</div>
{% endblock %}
