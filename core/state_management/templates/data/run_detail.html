{% extends "base.html" %}
{% from "macros/json_display.html" import json_viewer %}
{% block title %}Run {{ run.index }} - {{ record.AnalyzeUUID[:8] }}{% endblock %}
{% block page_title %}執行詳情{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 麵包屑導覽 -->
    <nav class="flex items-center space-x-2 text-sm text-gray-500">
        <a href="{{ url_for('views.data_list') }}" class="hover:text-blue-600">資料</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <a href="{{ url_for('views.data_detail', analyze_uuid=record.AnalyzeUUID) }}" class="hover:text-blue-600 font-mono">{{ record.AnalyzeUUID[:8] }}...</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <span class="text-gray-900">Run {{ run.index }}</span>
    </nav>

    <!-- Run 標題 -->
    <div class="tech-card">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Run {{ run.index }}</h3>
                    <p class="text-sm text-gray-500 mt-1 font-mono">{{ run.analysis_id }}</p>
                </div>
                <span class="tech-badge text-sm
                    {% if run.status == 'completed' %} tech-badge-success
                    {% elif run.status == 'processing' %} tech-badge-info
                    {% elif run.status == 'failed' %} tech-badge-danger
                    {% else %} tech-badge-warning {% endif %}">
                    <i class="fas {% if run.status == 'completed' %}fa-check-circle{% elif run.status == 'processing' %}fa-spinner fa-spin{% elif run.status == 'failed' %}fa-times-circle{% else %}fa-clock{% endif %} mr-1"></i>
                    {% if run.status == 'completed' %}已完成
                    {% elif run.status == 'processing' %}處理中
                    {% elif run.status == 'failed' %}失敗
                    {% else %}{{ run.status }}{% endif %}
                </span>
            </div>
        </div>

        <!-- 執行狀態 -->
        <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-b border-gray-100">
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">請求時間</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.requested_at or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">開始時間</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.started_at or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">完成時間</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.completed_at or '-' }}</dd>
            </div>
        </div>
    </div>

    <!-- 分析上下文 -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">分析上下文</h4>
        </div>
        <div class="px-6 py-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">路由 ID</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.router_id or '-' }}</dd>
                {% if router_name %}
                <dd class="text-xs text-gray-500">{{ router_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">路由規則</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.routing_rule_id or '-' }}</dd>
                {% if rule_name %}
                <dd class="text-xs text-gray-500">{{ rule_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">分析配置</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.analysis_config_id or '-' }}</dd>
                {% if config_name %}
                <dd class="text-xs text-gray-500">{{ config_name }}</dd>
                {% endif %}
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">分析方法</dt>
                <dd class="text-sm text-gray-800 mt-1">{{ run.analysis_method_id or '-' }}</dd>
            </div>
            <div>
                <dt class="text-xs font-semibold text-gray-500 uppercase">執行節點</dt>
                <dd class="text-sm text-gray-800 mt-1 font-mono">{{ run.node_id or '-' }}</dd>
            </div>
        </div>
    </div>

    <!-- 分析摘要 -->
    {% if run.analysis_summary %}
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">分析摘要</h4>
        </div>
        <div class="px-6 py-4">
            <div class="flex flex-wrap gap-3">
                {% for key, val in run.analysis_summary.items() %}
                <div class="bg-gray-100 rounded-lg px-4 py-2">
                    <span class="text-xs text-gray-500 uppercase block">{{ key }}</span>
                    <span class="text-sm font-semibold text-gray-800">{{ val }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 錯誤訊息 -->
    {% if run.error_message %}
    <div class="tech-card border-l-4 border-red-500">
        <div class="px-6 py-4">
            <h4 class="text-sm font-semibold text-red-600 uppercase mb-2">錯誤訊息</h4>
            <pre class="text-sm text-red-800 bg-red-50 p-3 rounded overflow-x-auto">{{ run.error_message }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- 處理步驟 -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">處理步驟</h4>
            <p class="text-xs text-gray-500 mt-1">共 {{ run.steps|length }} 個步驟</p>
        </div>
        <div class="px-6 py-4">
            {% if run.steps %}
            <div class="space-y-4">
                {% for step in run.steps %}
                <div class="border rounded-lg p-4 {% if step.features_state == 'completed' %}border-green-200 bg-green-50{% elif step.features_state == 'failed' or step.features_state == 'error' %}border-red-200 bg-red-50{% elif step.features_state == 'processing' %}border-blue-200 bg-blue-50{% else %}border-gray-200{% endif %}">
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="font-semibold text-gray-900">{{ step.name or step.features_name or '步驟 ' ~ loop.index }}</h5>
                        <span class="tech-badge text-xs
                            {% if step.features_state == 'completed' %}tech-badge-success
                            {% elif step.features_state == 'processing' %}tech-badge-info
                            {% elif step.features_state == 'failed' or step.features_state == 'error' %}tech-badge-danger
                            {% else %}tech-badge-warning{% endif %}">
                            {% if step.features_state == 'completed' %}已完成
                            {% elif step.features_state == 'processing' %}處理中
                            {% elif step.features_state == 'failed' or step.features_state == 'error' %}失敗
                            {% else %}{{ step.features_state or '未知' }}{% endif %}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        {% if step.started_at %}
                        <div>
                            <span class="text-gray-500">開始時間：</span>
                            <span class="text-gray-700">{{ step.started_at }}</span>
                        </div>
                        {% endif %}
                        {% if step.completed_at %}
                        <div>
                            <span class="text-gray-500">完成時間：</span>
                            <span class="text-gray-700">{{ step.completed_at }}</span>
                        </div>
                        {% endif %}
                        {% if step.processor_metadata %}
                        <div class="md:col-span-2">
                            <span class="text-gray-500">處理器資訊：</span>
                            <pre class="text-xs bg-white p-2 rounded mt-1 overflow-x-auto">{{ step.processor_metadata | tojson(indent=2) }}</pre>
                        </div>
                        {% endif %}
                        {% if step.features_data %}
                        <div class="md:col-span-2">
                            <span class="text-gray-500">資料筆數：</span>
                            <span class="text-gray-700">{{ step.features_data|length }} 筆</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">尚無處理步驟紀錄。</p>
            {% endif %}
        </div>
    </div>

    <!-- 原始 JSON 資料 -->
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">原始資料</h4>
        </div>
        <div class="px-6 py-4 space-y-4">
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">分析上下文 (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.analysis_context, 'analysis_context_raw', collapsed=false) }}
                </div>
            </details>
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">步驟 (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.steps, 'steps_raw', collapsed=false) }}
                </div>
            </details>
            <details class="tech-accordion">
                <summary class="tech-accordion-summary">分析摘要 (JSON)</summary>
                <div class="mt-3">
                    {{ json_viewer(run.analysis_summary, 'summary_raw', collapsed=false) }}
                </div>
            </details>
        </div>
    </div>

    <!-- 導覽：其他 Runs -->
    {% if runs|length > 1 %}
    <div class="tech-card">
        <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <h4 class="text-lg font-semibold text-gray-900">其他執行紀錄</h4>
        </div>
        <div class="px-6 py-4">
            <div class="flex flex-wrap gap-2">
                {% for r in runs %}
                {% if r.analysis_id != run.analysis_id %}
                <a href="{{ url_for('views.run_detail', analyze_uuid=record.AnalyzeUUID, analysis_id=r.analysis_id) }}"
                   class="inline-flex items-center px-3 py-1.5 rounded-lg border
                          {% if r.status == 'completed' %}border-green-300 bg-green-50 text-green-700 hover:bg-green-100
                          {% elif r.status == 'failed' %}border-red-300 bg-red-50 text-red-700 hover:bg-red-100
                          {% elif r.status == 'processing' %}border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100
                          {% else %}border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100{% endif %}
                          transition-colors">
                    <span class="text-sm font-medium">Run {{ r.index }}</span>
                    <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </a>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 返回按鈕 -->
    <div class="flex justify-between">
        <a href="{{ url_for('views.data_detail', analyze_uuid=record.AnalyzeUUID) }}" class="tech-button-outline">
            <i class="fas fa-arrow-left mr-2"></i>返回錄音詳情
        </a>
    </div>
</div>
{% endblock %}
