{% extends "base.html" %}
{% block title %}è³‡æ–™åˆ—è¡¨{% endblock %}
{% block page_title %}è³‡æ–™åˆ—è¡¨{% endblock %}

{% block content %}
{# ç¢ºä¿ filter_options æœ‰é è¨­å€¼ #}
{% set filter_options = filter_options|default({'dataset_uuids': [], 'routers': [], 'rules': [], 'configs': [], 'methods': []}) %}
{# å®šç¾©åˆ†é  URL ç”Ÿæˆ macro #}
{% macro page_url(target_page) %}
{{ url_for('views.data_list',
    q=request.args.get('q', ''),
    dataset_uuid=request.args.get('dataset_uuid', ''),
    router_id=request.args.get('router_id', ''),
    rule_id=request.args.get('rule_id', ''),
    config_id=request.args.get('config_id', ''),
    analysis_method_id=request.args.get('analysis_method_id', ''),
    status=request.args.get('status', ''),
    page_size=pagination.page_size,
    page=target_page
) }}
{% endmacro %}

<div class="space-y-6">
    <!-- ç¯©é¸å€å¡Š -->
    <div class="tech-card overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-indigo-50 via-purple-50 to-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-filter text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">è³‡æ–™ç¯©é¸</h3>
                        <p class="text-sm text-gray-500 mt-0.5">ä¾ç…§ Routerã€è¨­å®šæˆ–é—œéµå­—æŸ¥è©¢è³‡æ–™</p>
                    </div>
                </div>
                <a href="{{ url_for('views.data_list') }}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border-2 border-gray-200 text-gray-600 font-medium text-sm hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all duration-200">
                    <i class="fas fa-undo"></i>
                    <span>é‡ç½®ç¯©é¸</span>
                </a>
            </div>
        </div>
        <form id="filterForm" method="get" class="px-6 py-5 bg-gradient-to-b from-gray-50/50 to-white">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <!-- é—œéµå­—ï¼šä¿æŒ text input -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-search"></i>é—œéµå­—
                    </label>
                    <div class="tech-input-wrapper">
                        <i class="fas fa-search tech-input-icon"></i>
                        <input type="text" name="q" value="{{ request.args.get('q', '') }}"
                               class="tech-input" placeholder="UUID æˆ–æª”å...">
                    </div>
                </div>

                <!-- Dataset UUIDï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-database"></i>Dataset UUID
                    </label>
                    <select name="dataset_uuid" class="tech-input auto-submit">
                        <option value="">å…¨éƒ¨ Dataset</option>
                        {% for uuid in filter_options.dataset_uuids|default([]) %}
                        <option value="{{ uuid }}" {% if request.args.get('dataset_uuid') == uuid %}selected{% endif %}>
                            {{ uuid[:20] }}{% if uuid|length > 20 %}...{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Routerï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-route"></i>Router
                    </label>
                    <select name="router_id" class="tech-input auto-submit">
                        <option value="">å…¨éƒ¨ Router</option>
                        {% for router in filter_options.routers|default([]) %}
                        <option value="{{ router.id }}" {% if request.args.get('router_id') == router.id %}selected{% endif %}>
                            {{ router.name }} ({{ router.id[:8] }}...)
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- è·¯ç”±è¦å‰‡ï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-code-branch"></i>è·¯ç”±è¦å‰‡
                    </label>
                    <select name="rule_id" class="tech-input auto-submit">
                        <option value="">å…¨éƒ¨è¦å‰‡</option>
                        {% for rule in filter_options.rules|default([]) %}
                        <option value="{{ rule.id }}" {% if request.args.get('rule_id') == rule.id %}selected{% endif %}>
                            {{ rule.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- åˆ†æè¨­å®šï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-cog"></i>åˆ†æè¨­å®š
                    </label>
                    <select name="config_id" class="tech-input auto-submit">
                        <option value="">å…¨éƒ¨è¨­å®š</option>
                        {% for cfg in filter_options.configs|default([]) %}
                        <option value="{{ cfg.id }}" {% if request.args.get('config_id') == cfg.id %}selected{% endif %}>
                            {{ cfg.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- åˆ†ææ–¹æ³•ï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-flask"></i>åˆ†ææ–¹æ³•
                    </label>
                    <select name="analysis_method_id" class="tech-input auto-submit">
                        <option value="">å…¨éƒ¨æ–¹æ³•</option>
                        {% for method in filter_options.methods|default([]) %}
                        <option value="{{ method }}" {% if request.args.get('analysis_method_id') == method %}selected{% endif %}>
                            {{ method }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- è™•ç†ç‹€æ…‹ï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-tasks"></i>è™•ç†ç‹€æ…‹
                    </label>
                    <select name="status" class="tech-input auto-submit">
                        {% set current_status = request.args.get('status', '') %}
                        <option value="" {% if not current_status %}selected{% endif %}>å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>â³ ç­‰å¾…ä¸­</option>
                        <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>ğŸ”„ è™•ç†ä¸­</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>âœ… å·²å®Œæˆ</option>
                        <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>âŒ å¤±æ•—</option>
                    </select>
                </div>

                <!-- æ¯é ç­†æ•¸ï¼šä¸‹æ‹‰é¸å–® -->
                <div>
                    <label class="tech-label">
                        <i class="fas fa-list-ol"></i>æ¯é ç­†æ•¸
                    </label>
                    <select name="page_size" class="tech-input auto-submit">
                        {% for size in [10, 20, 50, 100] %}
                        <option value="{{ size }}" {% if pagination.page_size == size %}selected{% endif %}>{{ size }} ç­†</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- è³‡æ–™åˆ—è¡¨å€å¡Š -->
    <div class="tech-card overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-blue-50 via-indigo-50 to-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-table text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">è³‡æ–™åˆ—è¡¨</h3>
                        <p class="text-sm text-gray-500 mt-0.5">
                            å…± <span class="font-semibold text-indigo-600">{{ pagination.total }}</span> ç­†
                            {% if pagination.pages > 0 %}
                            ï¼Œç¬¬ <span class="font-semibold">{{ pagination.page }}</span> / {{ pagination.pages }} é 
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% if records %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è³‡æ–™</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dataset</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æœ€æ–°è·¯ç”±/è¨­å®š</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">çµæœ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸Šå‚³æ™‚é–“</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for rec in records %}
                    {% set latest = rec.latest_run %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold text-gray-900">{{ rec.filename or '-' }}</div>
                            <div class="text-xs text-gray-500 font-mono">{{ rec.analyze_uuid }}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {{ rec.dataset_uuid or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {% if latest %}
                                <div class="flex flex-col gap-1">
                                    {% if latest.router_id %}
                                    <div class="flex items-center gap-2">
                                        <span class="tech-badge tech-badge-info" title="Router ID: {{ latest.router_id }}">
                                            <i class="fas fa-route mr-1 text-xs"></i>
                                            {{ router_names.get(latest.router_id, latest.router_id[:12] ~ '...') }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if latest.analysis_config_id %}
                                    <div class="flex items-center gap-2">
                                        <span class="tech-badge tech-badge-secondary" title="Config ID: {{ latest.analysis_config_id }}">
                                            <i class="fas fa-cog mr-1 text-xs"></i>
                                            {{ config_names.get(latest.analysis_config_id, latest.analysis_config_id[:12] ~ '...') }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if latest.analysis_method_id %}
                                <div class="text-xs text-gray-500 mt-1">Method: {{ latest.analysis_method_id }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 text-xs">å°šç„¡åŸ·è¡Œç´€éŒ„</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if latest %}
                                {% set status = latest.status %}
                                <span class="tech-badge
                                    {% if status == 'completed' %} tech-badge-success
                                    {% elif status == 'processing' %} tech-badge-info
                                    {% elif status == 'failed' %} tech-badge-danger
                                    {% else %} tech-badge-warning {% endif %}">
                                    {{ status }}
                                </span>
                            {% else %}
                                <span class="text-gray-400 text-xs">æœªåŸ·è¡Œ</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {% if rec.latest_prediction %}
                                <span class="font-semibold">{{ rec.latest_prediction }}</span>
                            {% elif latest and latest.analysis_summary %}
                                <span class="text-gray-500 text-xs">æœ‰æ‘˜è¦</span>
                            {% else %}
                                <span class="text-gray-400 text-xs">æœªç”¢ç”Ÿ</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% set ts = rec.upload_time %}
                            {{ ts.strftime('%m/%d %H:%M') if ts and ts.__class__.__name__ == 'datetime' else ts or '-' }}
                        </td>
                        <td class="px-4 py-3 text-right text-sm">
                            <a href="{{ url_for('views.data_detail', analyze_uuid=rec.analyze_uuid) }}"
                               class="inline-flex items-center gap-2 px-3.5 py-2 rounded-lg text-sm font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 hover:border-indigo-300 hover:shadow-md transition-all duration-200">
                                <i class="fas fa-eye"></i>
                                <span>è©³æƒ…</span>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- åˆ†é å€å¡Š -->
        {% if pagination.pages > 1 %}
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50/50 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                é¡¯ç¤ºç¬¬ <span class="font-medium text-gray-700">{{ ((pagination.page - 1) * pagination.page_size) + 1 }}</span> -
                <span class="font-medium text-gray-700">{{ [pagination.page * pagination.page_size, pagination.total]|min }}</span> ç­†ï¼Œ
                å…± <span class="font-medium text-indigo-600">{{ pagination.total }}</span> ç­†
            </div>
            <div class="flex items-center gap-1.5">
                <!-- ä¸Šä¸€é  -->
                {% if pagination.page > 1 %}
                <a href="{{ page_url(pagination.page - 1) }}"
                   class="inline-flex items-center gap-1.5 px-3.5 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 bg-white hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-600 transition-all duration-200 shadow-sm">
                    <i class="fas fa-chevron-left text-xs"></i>
                    <span>ä¸Šä¸€é </span>
                </a>
                {% endif %}

                <!-- é ç¢¼æŒ‰éˆ• -->
                {% for p in range(1, pagination.pages + 1) %}
                    {% if p == pagination.page %}
                        <span class="inline-flex items-center justify-center min-w-[2.5rem] h-10 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg text-sm font-semibold shadow-md">{{ p }}</span>
                    {% elif p == 1 or p == pagination.pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                        <a href="{{ page_url(p) }}"
                           class="inline-flex items-center justify-center min-w-[2.5rem] h-10 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 bg-white hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-600 transition-all duration-200 shadow-sm">
                            {{ p }}
                        </a>
                    {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                        <span class="px-1 text-gray-400">...</span>
                    {% endif %}
                {% endfor %}

                <!-- ä¸‹ä¸€é  -->
                {% if pagination.page < pagination.pages %}
                <a href="{{ page_url(pagination.page + 1) }}"
                   class="inline-flex items-center gap-1.5 px-3.5 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 bg-white hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-600 transition-all duration-200 shadow-sm">
                    <span>ä¸‹ä¸€é </span>
                    <i class="fas fa-chevron-right text-xs"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% else %}
        <!-- åªæœ‰ä¸€é æ™‚ -->
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50/50">
            <div class="text-sm text-gray-500">
                å…± <span class="font-medium text-indigo-600">{{ pagination.total }}</span> ç­†è³‡æ–™
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- ç„¡è³‡æ–™æ™‚ -->
        <div class="px-6 py-16 text-center">
            <div class="tech-empty-state">
                <div class="mx-auto mb-4">
                    <i class="fas fa-database text-6xl text-gray-300"></i>
                </div>
                <p class="text-lg font-medium text-gray-600">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</p>
                <p class="text-sm text-gray-500 mt-2">è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–é‡ç½®ç¯©é¸ã€‚</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ‰€æœ‰å¸¶æœ‰ auto-submit class çš„ä¸‹æ‹‰é¸å–®ï¼Œé¸æ“‡å¾Œè‡ªå‹•æäº¤
    document.querySelectorAll('.auto-submit').forEach(function(select) {
        select.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });

    // é—œéµå­—è¼¸å…¥æ¡†æŒ‰ Enter æ™‚æäº¤
    const keywordInput = document.querySelector('input[name="q"]');
    if (keywordInput) {
        keywordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('filterForm').submit();
            }
        });
    }
});
</script>
{% endblock %}
