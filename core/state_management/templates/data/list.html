{% extends "base.html" %}
{% block title %}資料列表{% endblock %}
{% block page_title %}資料列表{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="tech-card">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">資料篩選</h3>
                    <p class="text-sm text-gray-600 mt-1">依照 Router、設定或關鍵字查詢資料並查看最新處理結果</p>
                </div>
                <a href="{{ url_for('views.data_list') }}" class="tech-button-outline">
                    <i class="fas fa-sync-alt mr-2"></i>重置篩選
                </a>
            </div>
        </div>
        <form method="get" class="px-6 py-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label class="tech-label">關鍵字 (UUID / 檔名)</label>
                <input type="text" name="q" value="{{ filters.get('q','') }}"
                       class="tech-input" placeholder="輸入 AnalyzeUUID 或檔名的一部分">
            </div>
            <div>
                <label class="tech-label">Dataset UUID</label>
                <input type="text" name="dataset_uuid" value="{{ filters.get('dataset_uuid','') }}" class="tech-input">
            </div>
            <div>
                <label class="tech-label">Router ID</label>
                <input type="text" name="router_id" value="{{ filters.get('router_id','') }}" class="tech-input">
            </div>
            <div>
                <label class="tech-label">Rule ID</label>
                <input type="text" name="rule_id" value="{{ filters.get('rule_id','') }}" class="tech-input">
            </div>
            <div>
                <label class="tech-label">設定 Config ID</label>
                <input type="text" name="config_id" value="{{ filters.get('config_id','') }}" class="tech-input">
            </div>
            <div>
                <label class="tech-label">分析方法</label>
                <input type="text" name="analysis_method_id" value="{{ filters.get('analysis_method_id','') }}" class="tech-input">
            </div>
            <div>
                <label class="tech-label">處理狀態</label>
                <select name="status" class="tech-input">
                    {% set status = filters.get('status','') %}
                    <option value="" {% if not status %}selected{% endif %}>全部</option>
                    <option value="pending" {% if status=='pending' %}selected{% endif %}>pending</option>
                    <option value="processing" {% if status=='processing' %}selected{% endif %}>processing</option>
                    <option value="completed" {% if status=='completed' %}selected{% endif %}>completed</option>
                    <option value="failed" {% if status=='failed' %}selected{% endif %}>failed</option>
                </select>
            </div>
            <div>
                <label class="tech-label">每頁筆數</label>
                <select name="page_size" class="tech-input">
                    {% set page_size = filters.get('page_size', pagination.page_size) %}
                    {% for size in [10,20,50,100] %}
                    <option value="{{ size }}" {% if page_size|string == size|string %}selected{% endif %}>{{ size }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="tech-button">
                    <i class="fas fa-filter mr-2"></i>套用篩選
                </button>
            </div>
        </form>
    </div>

    <div class="tech-card overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">資料列表</h3>
                    <p class="text-sm text-gray-600 mt-1">共 {{ pagination.total }} 筆，頁 {{ pagination.page }} / {{ pagination.pages }}</p>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">資料</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dataset</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">最新路由/設定</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">結果</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">上傳時間</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for rec in records %}
                    {% set latest = rec.latest_run %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold text-gray-900">{{ rec.filename or '-' }}</div>
                            <div class="text-xs text-gray-500 font-mono">{{ rec.analyze_uuid }}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {{ rec.dataset_uuid or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {% if latest %}
                                <div class="flex items-center gap-2">
                                    <span class="tech-badge tech-badge-info">Router {{ latest.router_id or '-' }}</span>
                                    <span class="tech-badge tech-badge-secondary">Config {{ latest.analysis_config_id or '-' }}</span>
                                </div>
                                {% if latest.analysis_method_id %}
                                <div class="text-xs text-gray-500 mt-1">Method: {{ latest.analysis_method_id }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 text-xs">尚無執行紀錄</span>
                        {% endif %}
                    </td>
                        <td class="px-4 py-3 text-sm">
                            {% if latest %}
                                {% set status = latest.status %}
                                <span class="tech-badge
                                    {% if status == 'completed' %} tech-badge-success
                                    {% elif status == 'processing' %} tech-badge-info
                                    {% elif status == 'failed' %} tech-badge-danger
                                    {% else %} tech-badge-warning {% endif %}">
                                    {{ status }}
                                </span>
                            {% else %}
                                <span class="text-gray-400 text-xs">未執行</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            {% if rec.latest_prediction %}
                                <span class="font-semibold">{{ rec.latest_prediction }}</span>
                            {% elif latest and latest.analysis_summary %}
                                <span class="text-gray-500 text-xs">有摘要</span>
                            {% else %}
                                <span class="text-gray-400 text-xs">未產生</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            {% set ts = rec.upload_time %}
                            {{ ts.strftime('%m/%d %H:%M') if ts and ts.__class__.__name__=='datetime' else ts or '-' }}
                        </td>
                        <td class="px-4 py-3 text-right text-sm">
                            <a href="{{ url_for('views.data_detail', analyze_uuid=rec.analyze_uuid) }}"
                               class="tech-button-outline">
                                <i class="fas fa-eye mr-2"></i>詳情
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-4 py-6 text-center text-sm text-gray-500">沒有符合條件的資料</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="px-6 py-4 flex items-center justify-between">
            <div class="text-sm text-gray-600">
                顯示第 {{ (pagination.page - 1) * pagination.page_size + 1 if pagination.total else 0 }}
                - {{ (pagination.page - 1) * pagination.page_size + records|length }} 筆，共 {{ pagination.total }} 筆
            </div>
            <div class="flex gap-2">
                <a href="{{ prev_url }}"
                   class="tech-button-outline {% if pagination.page<=1 %}opacity-50 cursor-not-allowed{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <a href="{{ next_url }}"
                   class="tech-button-outline {% if pagination.page>=pagination.pages %}opacity-50 cursor-not-allowed{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
